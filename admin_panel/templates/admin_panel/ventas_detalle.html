{% extends "admin_panel/base.html" %}
{% block title %}{{ venta.codigo_sucursal }}{% endblock %}
{% block header_title %}Detalle de venta {{ venta.codigo_sucursal }}{% endblock %}
{% load core_extras %}


{% block content %}
  <div style="margin-bottom:12px;">
    <a class="btn-flat" href="{% url 'admin_panel:ventas_lista' %}">
      <i class="material-icons left">arrow_back</i>Volver
    </a>
  </div>

  <div class="row">
    <div class="col s12 l5">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Resumen</span>
          <p><b>Fecha:</b> {{ venta.fecha|date:"d/m/Y H:i" }}</p>
          <p><b>Código:</b> {{ venta.codigo_sucursal }}</p>
          <p><b>Sucursal:</b> {{ venta.sucursal.nombre }}</p>
          <p><b>Estado:</b> {{ venta.get_estado_display }}</p>
          <p><b>Medios de pago:</b> {{ venta.medio_pago_ui }}</p>
          {% if venta.cliente %}
            <p><b>Cliente:</b> {{ venta.cliente.apellido }}, {{ venta.cliente.nombre }}{% if venta.cliente.dni %} ({{ venta.cliente.dni }}){% endif %}</p>
          {% endif %}
          <p><b>Total ítems:</b> {{ total_items|moneda_ar }}</p>
          <p><b>Recargos:</b> {{ total_recargos|moneda_ar }}</p>
          <p><b>Total final:</b> {{ venta.total|moneda_ar }}</p>
        </div>
      </div>

      <div class="card">
        <div class="card-content">
          <span class="card-title">Pagos</span>

          <div class="responsive-table">
          <table class="striped">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Detalle</th>
                <th class="right-align">Base</th>
                <th class="right-align">Recargo</th>
                <th class="right-align">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for p in pagos %}
                <tr>
                  <td>
                    <strong>{{ p.get_tipo_display }}</strong>
                  </td>
                  <td>
                    {% if p.tipo == "CREDITO" %}
                      <div class="grey-text" style="font-size:.85rem;">
                        {% if p.plan and p.plan.tarjeta %}{{ p.plan.tarjeta }} · {% endif %}
                        {{ p.cuotas }} cuotas
                        {% if p.recargo_pct|add:0 > 0 %} · Recargo {{ p.recargo_pct|floatformat:2 }}%{% endif %}
                      </div>
                    {% elif p.referencia %}
                      <div class="grey-text" style="font-size:.85rem;">Ref: {{ p.referencia }}</div>
                    {% else %}
                      <span class="grey-text">—</span>
                    {% endif %}
                  </td>
                  <td class="right-align">{{ p.monto|moneda_ar }}</td>
                  <td class="right-align">{{ p.recargo_monto_safe|moneda_ar }}</td>
                  <td class="right-align"><strong>{{ p.total_pago_admin|moneda_ar }}</strong></td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="grey-text">Sin pagos registrados.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% if pagos %}
            <div class="right-align" style="margin-top:10px;">
              <span class="grey-text">Total pagado:</span>
              <strong>{{ total_pagado|moneda_ar }}</strong>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col s12 l7">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Ítems</span>

          <div class="responsive-table">
            <table class="striped">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Producto</th>
                  <th class="right-align">Cant.</th>
                  <th class="right-align">Precio</th>
                  <th class="right-align">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for it in items %}
                  <tr>
                    <td>{{ it.variante.sku }}</td>
                    <td>{{ it.nombre_admin }}</td>
                    <td class="right-align">{{ it.cantidad }}</td>
                    <td class="right-align">{{ it.precio_unitario|moneda_ar }}</td>
                    <td class="right-align">{{ it.subtotal|moneda_ar }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="5" class="grey-text">Sin ítems.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
{% endblock %}
