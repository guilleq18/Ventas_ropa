{% load caja_extras %}

{% if not items %}
  <p class="grey-text">Carrito vacío.</p>
{% else %}
  <ul class="collection">
    {% for it in items %}
      {% with st=stock_map|get_item:it.variante.id|default:0 %}
      <li class="collection-item">
        <div>
          <strong>{{ it.variante.sku }}</strong><br>
          <span class="grey-text">{{ it.variante.producto.nombre }}</span>
          <span class="right"><strong>${{ it.subtotal }}</strong></span>

          <div style="margin-top:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            {% if st|add:0 <= 0 %}
              <span class="chip red lighten-4 red-text text-darken-4">Sin stock</span>
            {% else %}
              <span class="chip green lighten-5 green-text text-darken-2">Stock: {{ st }}</span>
            {% endif %}
            {% if sucursal %}
              <span class="grey-text" style="font-size:12px;">{{ sucursal.nombre }}</span>
            {% endif %}
          </div>

          <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;">
            <form hx-post="{% url 'caja:carrito_set_qty' it.variante.id %}"
                  hx-target="#carrito_body"
                  hx-swap="innerHTML">
              {% csrf_token %}
              <input type="number"
                     name="qty"
                     min="1"
                     value="{{ it.qty }}"
                     style="max-width:90px;"
                     {% if st|add:0 > 0 %}max="{{ st }}"{% endif %}>
              <button class="btn grey darken-1" type="submit">Actualizar</button>
            </form>

            <form hx-post="{% url 'caja:carrito_quitar' it.variante.id %}"
                  hx-target="#carrito_body"
                  hx-swap="innerHTML">
              {% csrf_token %}
              <button class="btn red" type="submit">Quitar</button>
            </form>
          </div>
        </div>
      </li>
      {% endwith %}
    {% endfor %}
  </ul>
{% endif %}

{# ✅ OOB: total del header del carrito #}
<strong id="carrito_total_header" hx-swap-oob="innerHTML">${{ total }}</strong>

{# ✅ OOB: refrescar pagos cuando cambia el carrito #}
{% if oob_pagos %}
  <div id="pagos_body" hx-swap-oob="innerHTML">
    {% include "caja/_pagos_body.html" %}
  </div>
{% endif %}
