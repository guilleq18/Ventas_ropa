{# templates/caja/_carrito.html #}
{% load caja_extras %}

{% if not items %}
  <p class="grey-text">Carrito vacío.</p>
{% else %}

  <table class="highlight responsive-table" style="font-size:13px;">
    <thead>
      <tr>
        <th style="width:24%;">Producto</th>
        <th style="width:9%;">Stock</th>
        <th style="width:9%;">Cant.</th>
        <th style="width:12%;">Precio</th>
        <th class="right-align" style="width:10%;">Desc.</th>
        <th class="right-align" style="width:12%;">Neto</th>
        <th class="right-align" style="width:9%;">IVA</th>
        <th class="right-align" style="width:11%;">Subtotal</th>
        <th class="right-align" style="width:4%;">Acción</th>
      </tr>
    </thead>

    <tbody>
      {% for it in items %}
        {% with st=stock_map|get_item:it.variante.id|default:0 %}
        <tr>
          <td style="padding-top:10px; padding-bottom:10px;">
            <div style="font-weight:600; line-height:1.2;">{{ it.variante.sku }}</div>
            <div class="grey-text" style="font-size:12px; line-height:1.2;">
              {{ it.variante.producto.nombre }}
            </div>
            {% if sucursal %}
              <div class="grey-text" style="font-size:11px; margin-top:4px;">
                {{ sucursal.nombre }}
              </div>
            {% endif %}
          </td>

          <td style="padding-top:10px; padding-bottom:10px;">
            {% if not permitir_sin_stock %}
              {% if st|add:0 <= 0 %}
                <span class="chip red lighten-4 red-text text-darken-4"
                      style="height:24px; line-height:24px; font-size:12px;">
                  Sin stock
                </span>
              {% else %}
                <span class="chip green lighten-5 green-text text-darken-2"
                      style="height:24px; line-height:24px; font-size:12px;">
                  {{ st }}
                </span>
              {% endif %}
            {% endif %}
          </td>

          <td style="padding-top:10px; padding-bottom:10px;">
            <form hx-post="{% url 'caja:carrito_set_qty' it.variante.id %}"
                  hx-target="#carrito_body"
                  hx-swap="innerHTML"
                  hx-trigger="input changed delay:180ms, change"
                  hx-sync="#carrito_body:replace"
                  style="margin:0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              {% csrf_token %}
              <input type="number"
                     name="qty"
                     min="1"
                     value="{{ it.qty }}"
                     style="max-width:78px; height:32px; margin:0;"
                     {% if st|add:0 > 0 %}max="{{ st }}"{% endif %}>
            </form>
          </td>

          <td style="padding-top:10px; padding-bottom:10px;">
            {% if permitir_cambiar_precio_venta %}
              <form hx-post="{% url 'caja:carrito_set_precio' it.variante.id %}"
                    hx-target="#carrito_body"
                    hx-swap="innerHTML"
                    style="margin:0; display:flex; align-items:center;">
                {% csrf_token %}
                <input type="text" name="precio" value="{{ it.precio }}" style="max-width:120px; height:32px; margin:0;" onchange="this.form.requestSubmit();">
              </form>
            {% else %}
              <div style="height:32px; display:flex; align-items:center;">${{ it.precio|num_ar }}</div>
            {% endif %}
          </td>

          <td class="right-align" style="padding-top:10px; padding-bottom:10px; white-space:nowrap;">
            {% if it.descuento|add:0 > 0 %}
              <span class="green-text text-darken-2">-${{ it.descuento|num_ar }}</span>
            {% else %}
              <span class="grey-text">$0,00</span>
            {% endif %}
          </td>

          <td class="right-align" style="padding-top:10px; padding-bottom:10px; white-space:nowrap;">
            <span>${{ it.fiscal_subtotal.monto_sin_impuestos_nacionales|num_ar }}</span>
          </td>

          <td class="right-align" style="padding-top:10px; padding-bottom:10px; white-space:nowrap;">
            <span>${{ it.fiscal_subtotal.iva_contenido|num_ar }}</span>
          </td>

          <td class="right-align" style="padding-top:10px; padding-bottom:10px; white-space:nowrap;">
            <strong>${{ it.subtotal|num_ar }}</strong>
          </td>

          <td class="right-align" style="padding-top:10px; padding-bottom:10px;">
            <form hx-post="{% url 'caja:carrito_quitar' it.variante.id %}"
                  hx-target="#carrito_body"
                  hx-swap="innerHTML"
                  style="margin:0;">
              {% csrf_token %}
              <button class="btn-small red" type="submit" style="height:32px; line-height:32px;" title="Quitar" aria-label="Quitar">
                <i class="material-icons" style="font-size:18px; line-height:32px;">delete</i>
              </button>
            </form>
          </td>
        </tr>
        {% endwith %}
      {% endfor %}
    </tbody>
  </table>

{% endif %}


{# Si desde el carrito también refrescamos pagos, incluimos el body SIN sus OOB (para no duplicar) #}
{% if oob_pagos %}
  <div hx-swap-oob="innerHTML:#pagos_body">
    {% include "caja/_pagos_body.html" with suppress_oob=True %}
  </div>
{% endif %}

{# Header de totales del card Pagos #}
<div hx-swap-oob="innerHTML:#pagos_totales" style="display:none">
  {% include "caja/_pagos_totales.html" %}
</div>

{# Totales visibles (card carrito + barra confirmar) #}
<div hx-swap-oob="innerHTML:#total_cobrar_card" style="display:none">{{ total_cobrar|num_ar }}</div>
<div hx-swap-oob="innerHTML:#total_cobrar_confirm" style="display:none">{{ total_cobrar|num_ar }}</div>
