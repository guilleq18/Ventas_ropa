{# templates/caja/pos.html #}
{% load caja_extras %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Caja</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/css/materialize.min.css">
  <script src="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/js/materialize.min.js"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <style>
    /* =======================
       Modal Venta
    ======================= */
    #venta_modal.modal{
      width: 85% !important;
      max-width: 1100px !important;
    }
    @media (max-width: 600px){
      #venta_modal.modal{ width: 95% !important; }
    }

    /* =======================
       Layout cards POS
    ======================= */
    .pos-card{ display:flex; flex-direction:column; min-height:0; }
    .pos-card .card-content{ display:flex; flex-direction:column; height:100%; min-height:0; }
    .pos-card .card-head{ flex:0 0 auto; }
    .pos-card .card-body{
      flex:1 1 auto;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-top:1px solid rgba(0,0,0,.08);
      margin-top:10px;
      padding-top:10px;
      min-height:0;
    }
    .pos-card .card-body .collection{ margin:0; }

    .card-head.sticky-head{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #fff;
      padding-bottom: 8px;
    }

    .card-head-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-head-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    @media (min-width: 601px){
      .card-search{ height: calc(100vh - 220px); }
      .card-carrito{ height: calc((100vh - 240px) * 0.45); }
      .card-pagos{ height: calc((100vh - 240px) * 0.55); }
    }

    @media (max-width: 600px){
      .card-search, .card-carrito, .card-pagos{ height:auto; }
      .card-search .card-body{ max-height: 300px; }
      .card-carrito .card-body{ max-height: 260px; }
      .card-pagos .card-body{ max-height: 340px; }
    }

    /* Selects */
    .select-wrapper input.select-dropdown{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pagos-select .select-wrapper input.select-dropdown{
      padding-right: 2.2rem !important;
      box-sizing:border-box;
    }
    .pagos-select .select-wrapper .caret{ right:.5rem; }

    /* Barra sticky inferior */
    .pos-sticky{
      position: sticky;
      bottom: 0;
      z-index: 999;
      border-top: 1px solid rgba(0,0,0,.08);
    }
    .pos-sticky .card-content{ padding: 12px 16px; }
    .pos-sticky .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin:0;
    }
    .pos-sticky .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pos-sticky .right{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .touch-btn{ height:48px; line-height:48px; }
    .chip.sucursal-chip{ font-weight:600; }
    @media (max-width: 600px){
      .pos-sticky .controls{ gap:10px; }
      .pos-sticky .right{ width:100%; justify-content:stretch; }
      .pos-sticky .right .btn-large{ width:100%; }
    }

    /* =======================
       NAV POS (pro)
    ======================= */
    .pos-nav{
      background: #0f172a;
    }
    .pos-nav .brand-logo{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .pos-nav .nav-badge{
      font-size: 12px;
      opacity: .85;
      margin-left: 10px;
      font-weight: 600;
    }
    .pos-nav .nav-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.15);
      border-radius:999px;
      font-size:12px;
      line-height:1;
      color:#fff;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .pos-nav .nav-chip i{ font-size:18px; }
    .pos-nav .nav-actions a{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pos-nav .btn-flat{
      color:#fff;
    }
    .pos-nav .btn-flat:hover{
      background: rgba(255,255,255,.08);
    }

    .dropdown-content{
      border-radius:10px;
      overflow:hidden;
    }
    .dropdown-content li>a, .dropdown-content li>span{
      font-size:14px;
    }

    .pos-nav .nav-wrapper{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .pos-nav .brand-logo{
      position: static !important;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .pos-nav ul.right{
      position: static !important;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pos-nav i.material-icons{
      text-transform:none !important;
    }

    @media (max-width: 1100px){
      #nav_clock{ display:none; }
    }
  </style>
</head>

<body class="grey lighten-4">

  <!-- NAV -->
  <nav class="pos-nav z-depth-1">
    <div class="nav-wrapper container">
      <a href="{% url 'caja:pos' %}" class="brand-logo">
        Caja <span class="nav-badge">POS</span>
      </a>

      <a href="#" data-target="mobile_nav" class="sidenav-trigger">
        <i class="material-icons">menu</i>
      </a>

      <ul class="right hide-on-med-and-down nav-actions">
        <li>
          <span class="nav-chip">
            <i class="material-icons">store</i>
            {{ sucursal.nombre }}
          </span>
        </li>

        <li>
          <span class="nav-chip" id="nav_clock">
            <i class="material-icons">schedule</i>
            --:--
          </span>
        </li>

        <li>
          <a class="btn-flat waves-effect" href="{% url 'caja:pos' %}">
            <i class="material-icons">add_shopping_cart</i>
            Nueva venta
          </a>
        </li>

        <li>
          <a class="btn-flat waves-effect" href="/admin/" target="_blank">
            <i class="material-icons">settings</i>
            Admin
          </a>
        </li>

        <li>
          <a class="dropdown-trigger btn-flat waves-effect" href="#!" data-target="user_dd">
            <i class="material-icons">account_circle</i>
            {{ request.user.username|default:"Usuario" }}
            <i class="material-icons right">arrow_drop_down</i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <ul id="user_dd" class="dropdown-content">
    <li><a href="/admin/password_change/" target="_blank"><i class="material-icons">lock</i>Cambiar clave</a></li>
    <li class="divider" tabindex="-1"></li>
    <li><a href="/admin/logout/"><i class="material-icons">logout</i>Salir</a></li>
  </ul>

  <ul class="sidenav" id="mobile_nav">
    <li>
      <div class="user-view" style="background:#0f172a;">
        <span class="white-text" style="font-weight:800;">Caja POS</span>
        <span class="white-text" style="opacity:.85;">{{ sucursal.nombre }}</span>
        <span class="white-text" style="opacity:.85;">{{ request.user.username|default:"Usuario" }}</span>
      </div>
    </li>
    <li><a href="{% url 'caja:pos' %}"><i class="material-icons">add_shopping_cart</i>Nueva venta</a></li>
    <li><a href="/admin/" target="_blank"><i class="material-icons">settings</i>Admin</a></li>
    <li><a href="/admin/logout/"><i class="material-icons">logout</i>Salir</a></li>
  </ul>

  <div class="container" style="margin-top:18px;">
    <div class="row">

      <!-- IZQ: Buscar -->
      <div class="col s12 m6">
        <div class="card pos-card card-search">
          <div class="card-content">

            <div class="card-head sticky-head">
              <span class="card-title">Buscar (SKU)</span>

              <div class="input-field" style="margin-bottom:0;">
                <input id="q" name="q" type="text"
                       autocomplete="off"
                       placeholder="Ej: REM-BAS-M-NEG o Remera o 779..."
                       hx-get="{% url 'caja:buscar' %}"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#resultados"
                       hx-swap="innerHTML">
                <label for="q">SKU / nombre / código de barras</label>
              </div>
            </div>

            <div class="card-body" id="buscar_scroll">
              <div id="resultados">
                {% include "caja/_resultados.html" with results=None %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- DER: Carrito + Pagos -->
      <div class="col s12 m6">

        <!-- Carrito -->
        <div class="card pos-card card-carrito">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Carrito</span>

                <div class="card-head-actions">
                  <span class="grey-text text-darken-1">
                    Total Items: $<strong id="total_cobrar_card">{{ total_cobrar|num_ar }}</strong>
                  </span>

                  <form hx-post="{% url 'caja:carrito_vaciar' %}"
                        hx-target="#carrito_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button class="btn red lighten-1 waves-effect waves-light" type="submit">
                      Vaciar
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <div class="card-body" id="carrito_scroll">
              <div id="carrito_body">
                {% include "caja/_carrito.html" with items=cart_items total=cart_total %}
              </div>
            </div>

          </div>
        </div>

        <!-- Pagos (CARD COMPLETA) -->
        <div class="card pos-card card-pagos">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Pagos</span>

                <div class="card-head-actions">
                  {# ✅ POST con CSRF (si lo hacés con button suelto, Django te tira 403) #}
                  <form hx-post="{% url 'caja:pagos_add_modal' %}"
                        hx-target="#pagos_modal_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button type="button"
                            class="btn teal waves-effect waves-light"
                            hx-post="{% url 'caja:pagos_modal_open' %}"
                            hx-target="#pago_modal_content"
                            hx-swap="innerHTML">
                      Agregar forma de pago
                    </button>

                  </form>
                </div>
              </div>

              <div id="pagos_totales" style="margin-top:6px;">
                {% include "caja/_pagos_totales.html" %}
              </div>
            </div>

            <div class="card-body" id="pagos_scroll">
              <div id="pagos_table">
                {% include "caja/_pagos_table.html" with payments=payments %}
              </div>
            </div>

          </div>
        </div>

      </div><!-- /col der -->

    </div><!-- /row -->

    <!-- Barra sticky inferior (Confirmación) -->
    <div class="card pos-sticky">
      <div class="card-content">
        <form
          hx-post="{% url 'caja:confirmar' %}"
          hx-target="#confirm_res"
          hx-swap="innerHTML"
          hx-target-error="#confirm_res"
        >
          {% csrf_token %}
          <input id="confirm_token_input" type="hidden" name="confirm_token" value="{{ confirm_token }}">

          <div class="controls">
            <div class="left">
              <span class="grey-text text-darken-1">Sucursal</span>
              <div class="chip sucursal-chip">{{ sucursal.nombre }}</div>

              <span class="grey-text text-darken-1">
                Total a cobrar: $<strong id="total_cobrar_confirm">{{ total_cobrar|num_ar }}</strong>
              </span>
            </div>

            <div class="right">
              <button class="btn-large waves-effect waves-light green touch-btn" type="submit">
                Confirmar venta
              </button>
            </div>
          </div>
        </form>

        <div id="confirm_res" style="margin-top:10px;"></div>
      </div>
    </div>

  </div><!-- /container -->

  {# =======================
     Modal Pagos
  ======================= #}
    <div id="pago_modal" class="modal modal-fixed-footer">
    <div class="modal-content" id="pago_modal_content">
      <!-- HTMX inyecta SOLO el body acá -->
    </div>

    <div class="modal-footer">
      

      <a href="#!" class="btn blue waves-effect waves-light modal-close">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>
  </div>

  {# =======================
     Modal Venta (post-confirm)
  ======================= #}
  {% if last_sale %}
    <div id="venta_modal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h5 style="margin-top:0;">Venta #{{ last_sale.id }}</h5>

        <div class="grey-text" style="margin-bottom:12px;">
          {{ last_sale.fecha|date:"d/m/Y H:i" }} — {{ last_sale.sucursal.nombre }}
        </div>

        <h6 style="margin:14px 0 8px;">Items</h6>
        <table class="striped" style="font-size:13px;">
          <thead>
            <tr>
              <th style="width:50%;">Producto</th>
              <th style="width:12%;">Cant.</th>
              <th class="right-align" style="width:19%;">Unit.</th>
              <th class="right-align" style="width:19%;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for it in last_sale.items.all %}
              <tr>
                <td>
                  <div style="font-weight:600; line-height:1.2;">{{ it.variante.sku }}</div>
                  <div class="grey-text" style="font-size:12px; line-height:1.2;">
                    {{ it.variante.producto.nombre }}
                  </div>
                </td>
                <td>{{ it.cantidad }}</td>
                <td class="right-align">${{ it.precio_unitario|num_ar }}</td>
                <td class="right-align"><strong>${{ it.subtotal|num_ar }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top:8px; text-align:right;">
          <span class="grey-text text-darken-2">Total por items:</span>
          <strong>${{ last_sale_total_items|num_ar }}</strong>
        </div>

        <h6 style="margin:16px 0 8px;">Formas de pago</h6>
        <ul class="collection" style="margin:0;">
          {% for p in last_sale_pagos %}
            <li class="collection-item" style="display:flex; justify-content:space-between; gap:12px;">
              <div>
                <div style="font-weight:600;">{{ p.get_tipo_display }}</div>

                {% if p.tipo == "CREDITO" %}
                  <div class="grey-text" style="font-size:12px;">
                    {% if p.plan %}{{ p.plan.tarjeta }} — {% endif %}
                    {{ p.cuotas }} cuotas
                    {% if p.recargo_pct|add:0 > 0 %} — Recargo {{ p.recargo_pct|num_ar }}%{% endif %}
                  </div>
                {% endif %}

                {% if p.referencia %}
                  <div class="grey-text" style="font-size:12px;">Ref: {{ p.referencia|num_ar }}</div>
                {% endif %}
              </div>

              <div style="text-align:right; white-space:nowrap;">
                <strong>${{ p.monto|num_ar }}</strong>
                {% if p.tipo == "CREDITO" and p.recargo_calc|add:0 > 0 %}
                  <div class="grey-text" style="font-size:12px;">Recargo: +${{ p.recargo_calc|num_ar }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>

        <div style="margin-top:14px; text-align:right;">
          <span class="grey-text text-darken-2">Total venta:</span>
          <strong style="font-size:18px;">
            {{ last_sale_total_final|num_ar }}
          </strong>
        </div>

      </div>

      <div class="modal-footer">
      

      <a href="#!" class="modal-close btn-flat">Cerrar</a>
      <a href="{% url 'caja:ticket' last_sale.id %}?print=1"
        target="_blank" rel="noopener"
        class="btn blue waves-effect waves-light"
        onclick="closeVentaModalAndFocus();">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>

    </div>
  {% endif %}

  <script>
    // =========================
    // Utils
    // =========================
    function initSelects(root){
      if (!window.M || !M.FormSelect) return;
      var elems = (root || document).querySelectorAll('select');
      M.FormSelect.init(elems);
    }

    function initNav(){
      if (!window.M) return;

      const dd = document.querySelectorAll('.dropdown-trigger');
      M.Dropdown.init(dd, { coverTrigger:false, constrainWidth:false });

      const sidenavs = document.querySelectorAll('.sidenav');
      M.Sidenav.init(sidenavs);

      const el = document.getElementById("nav_clock");
      function tick(){
        if(!el) return;
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        el.innerHTML = '<i class="material-icons">schedule</i> ' + hh + ':' + mm;
      }
      tick();
      setInterval(tick, 10000);
    }

    function centerVentaModal(){
      const modalEl = document.getElementById("venta_modal");
      if (!modalEl) return;

      modalEl.style.position = "fixed";

      const w = modalEl.offsetWidth || 0;
      const left = Math.max((window.innerWidth - w) / 2, 12);

      modalEl.style.left = left + "px";
      modalEl.style.right = "auto";
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    // =========================
    // DOM Ready
    // =========================
    document.addEventListener('DOMContentLoaded', function() {
      initSelects(document);
      initNav();

      // Modal pagos
      const pagoModalEl = document.getElementById('pago_modal');
      if (pagoModalEl && window.M && M.Modal) {
        M.Modal.init(pagoModalEl, { dismissible:true });
      }

      // Modal venta
      const ventaModalEl = document.getElementById('venta_modal');
      if (ventaModalEl && window.M && M.Modal) {
        const inst = M.Modal.init(ventaModalEl, {
          dismissible: true,
          onOpenEnd: centerVentaModal
        });

        inst.open();
        setTimeout(centerVentaModal, 0);
        setTimeout(centerVentaModal, 50);
        window.addEventListener("resize", centerVentaModal);
      }

      // Enter en búsqueda => scan_add
      const input = document.getElementById("q");
      if (input) {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const q = input.value.trim();
            if (!q) return;

            htmx.ajax("POST", "{% url 'caja:scan_add' %}", {
              target: "#carrito_body",
              swap: "innerHTML",
              values: { q },
              headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            input.value = "";
          }
        });
      }
    });

    // Abrir/cerrar modal pagos vía triggers
    document.body.addEventListener("openPagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      const inst = M.Modal.getInstance(el) || M.Modal.init(el, { dismissible:true });
      inst.open();
    });

    document.body.addEventListener("closePagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      const inst = M.Modal.getInstance(el);
      if (inst) inst.close();
    });

    // =========================
    // HTMX hooks
    // =========================
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      initSelects(evt.target);

      if (evt.target && evt.target.id === "carrito_body") {
        const wrap = document.getElementById("carrito_scroll");
        if (wrap) wrap.scrollTop = 0;

        const q = document.getElementById("q");
        if (q) q.focus();
      }
    });

    document.body.addEventListener('htmx:oobAfterSwap', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:oobAfterSettle', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      initSelects(document);
    });

    document.body.addEventListener("htmx:responseError", function (evt) {
      const target = document.querySelector("#confirm_res");
      if (!target) return;
      target.innerHTML = evt.detail.xhr.responseText || "Error al confirmar.";
    });

    document.body.addEventListener("posToast", function (evt) {
      if (window.M && M.toast) {
        M.toast({ html: evt.detail.message });
      } else {
        alert(evt.detail.message);
      }
    });
  </script>

</body>
</html>
