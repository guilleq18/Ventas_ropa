{# templates/caja/pos.html #}
{% load caja_extras static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Caja</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'branding/vgc-favicon.svg' %}">
  <link rel="shortcut icon" href="{% static 'branding/vgc-favicon.svg' %}">

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/css/materialize.min.css">
  <script src="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/js/materialize.min.js"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <style>
    :root{
      --pos-warm-bg: #f4e7e0;
      --pos-warm-shell: #efd8cd;
      --pos-card-bg: #f7eee8;
      --pos-card-head: #f2e0d4;
      --pos-card-border: rgba(156, 103, 76, 0.18);
      --pos-divider: rgba(156, 103, 76, 0.14);
      --pos-nav-bg: #7b4f43;
      --pos-nav-bg-2: #6f463b;
      --pos-nav-border: rgba(255,255,255,.14);
      --pos-nav-hover: rgba(255,255,255,.10);
      --pos-radius-md: 12px;
      --pos-radius-lg: 14px;
      --pos-shadow-soft: 0 8px 22px rgba(106, 68, 51, 0.08);
      --pos-shadow-card: 0 10px 24px rgba(106, 68, 51, 0.10);
    }
    /* =======================
       Modal Venta
    ======================= */
    #venta_modal.modal{
      width: 85% !important;
      max-width: 1100px !important;
      border-radius: 14px;
      overflow: hidden;
      background: var(--pos-card-bg);
      border: 1px solid rgba(121, 85, 72, 0.14);
      box-shadow: 0 16px 40px rgba(80, 52, 40, 0.18);
    }
    #venta_modal .modal-content{
      background:
        radial-gradient(circle at top right, rgba(255,255,255,.65), rgba(255,255,255,0) 48%),
        var(--pos-card-bg);
      padding: 18px 20px 14px;
    }
    #venta_modal .venta-modal-title{
      margin: 0;
      font-weight: 700;
      color: #4e342e;
      letter-spacing: .2px;
    }
    #venta_modal .venta-modal-meta{
      margin-top: 6px;
      margin-bottom: 14px;
      color: #6d4c41 !important;
      font-size: 13px;
    }
    #venta_modal .venta-section-title{
      margin: 14px 0 8px;
      font-weight: 700;
      color: #4e342e;
      font-size: 15px;
    }
    #venta_modal .venta-soft-panel{
      background: rgba(255,255,255,.52);
      border: 1px solid rgba(121, 85, 72, 0.12);
      border-radius: 12px;
      padding: 10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    #venta_modal .venta-items-table{
      margin: 0;
      border: 1px solid rgba(121, 85, 72, 0.10);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    #venta_modal .venta-items-table thead{
      background: rgba(121, 85, 72, 0.08);
    }
    #venta_modal .venta-items-table th{
      color: #5d4037;
      font-weight: 700;
      font-size: 12px;
      border-bottom: 1px solid rgba(121, 85, 72, 0.10);
    }
    #venta_modal .venta-items-table td{
      font-size: 13px;
      vertical-align: top;
    }
    #venta_modal .venta-subtotal-line,
    #venta_modal .venta-total-line{
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(121, 85, 72, 0.10);
      background: rgba(255,255,255,.72);
    }
    #venta_modal .venta-total-line{
      background: rgba(255,255,255,.88);
    }
    #venta_modal .venta-payments-list{
      margin: 0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(121, 85, 72, 0.10);
      background: #fff;
    }
    #venta_modal .venta-payments-list .collection-item{
      border-bottom: 1px solid rgba(121, 85, 72, 0.08);
      padding: 10px 12px;
      background: rgba(255,255,255,.9);
    }
    #venta_modal .venta-payments-list .collection-item:last-child{
      border-bottom: none;
    }
    #venta_modal .venta-payment-meta{
      font-size: 12px;
      color: #6d4c41 !important;
      line-height: 1.3;
    }
    #venta_modal .venta-payment-ref{
      font-size: 11px;
      color: #8d6e63 !important;
      line-height: 1.25;
    }
    #venta_modal .venta-payment-amount{
      text-align: right;
      white-space: nowrap;
      min-width: 132px;
      padding-left: 8px;
    }
    #venta_modal .venta-payment-amount strong{
      color: #4e342e;
      font-size: 16px;
    }
    #venta_modal .venta-payment-extra{
      font-size: 12px;
      color: #6d4c41 !important;
      margin-top: 2px;
    }
    #venta_modal .venta-modal-footer{
      background: linear-gradient(180deg, rgba(242,224,212,.9), rgba(247,238,232,.95));
      border-top: 1px solid rgba(121, 85, 72, 0.12);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    #venta_modal .venta-modal-footer .btn,
    #venta_modal .venta-modal-footer .btn-flat{
      border-radius: 10px;
    }
    @media (max-width: 600px){
      #venta_modal.modal{ width: 95% !important; }
      #venta_modal .modal-content{ padding: 14px 12px 10px; }
      #venta_modal .venta-payment-amount{ min-width: 0; }
      #venta_modal .venta-payments-list .collection-item{
        flex-direction: column;
        align-items: flex-start !important;
      }
      #venta_modal .venta-payment-amount{
        width: 100%;
        text-align: left;
        padding-left: 0;
      }
    }

    /* =======================
       Layout cards POS
    ======================= */
    .pos-card{
      display:flex;
      flex-direction:column;
      min-height:0;
      background: var(--pos-card-bg);
      border: 1px solid var(--pos-card-border);
      border-radius: var(--pos-radius-lg);
      overflow: hidden;
      box-shadow: var(--pos-shadow-card);
    }
    .pos-card .card-content{ display:flex; flex-direction:column; height:100%; min-height:0; }
    .pos-card .card-head{ flex:0 0 auto; }
    .pos-card .card-body{
      flex:1 1 auto;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-top:1px solid var(--pos-divider);
      margin-top:10px;
      padding-top:10px;
      min-height:0;
    }
    .pos-card .card-body .collection{ margin:0; }

    .card-head.sticky-head{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--pos-card-head);
      padding: 12px;
      padding-bottom: 10px;
      border: 1px solid rgba(121, 85, 72, 0.10);
      border-radius: var(--pos-radius-md);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }

    .card-head-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-head-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(121, 85, 72, 0.10);
      background: rgba(255,255,255,.38);
    }
    .pos-scan-input{
      width: 240px;
      max-width: 100%;
      height: 36px;
      padding: 0 10px;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      box-sizing: border-box;
      background: #fff;
    }
    .card-head-actions .btn,
    .card-head-actions .btn-flat{
      border-radius: 10px;
    }
    .card-head-actions form{
      margin: 0;
    }

    /* Header de carrito: mejor adaptación en anchos intermedios */
    .card-carrito .card-head-actions{
      width: 100%;
      justify-content: flex-start;
    }
    .card-carrito .card-head-actions #btn_open_buscar{
      margin-right: 0 !important;
      flex: 0 0 auto;
    }
    .card-carrito .card-head-actions .pos-scan-input{
      flex: 1 1 240px;
      min-width: 190px;
    }
    .card-carrito .card-head-actions form{
      margin: 0;
      flex: 0 0 auto;
    }
    .card-pagos .card-head-actions{
      width: 100%;
      justify-content: flex-start;
      gap: 8px;
    }
    .card-pagos .sticky-head > div:last-child{
      margin-top: 12px !important;
      padding: 10px 12px !important;
      border-top: none !important;
      border: 1px solid rgba(121, 85, 72, 0.10);
      border-radius: 10px;
      background: rgba(255,255,255,.32);
    }
    .card-pagos .card-head-actions form{
      margin: 0;
      flex: 0 0 auto;
    }

    @media (max-width: 992px){
      .card-carrito .card-head-row{
        align-items: flex-start;
      }
      .card-carrito .card-head-actions{
        gap: 8px;
      }
      .card-carrito .card-head-actions .pos-scan-input{
        flex-basis: 100%;
        min-width: 0;
        width: 100%;
      }

      .card-pagos .card-head-row{
        align-items: flex-start;
      }
      .card-pagos .card-head-actions{
        width: 100%;
      }
      .card-pagos .card-head-actions form{
        flex: 1 1 auto;
      }
      .card-pagos .card-head-actions form button{
        width: 100%;
        padding-left: 12px;
        padding-right: 12px;
      }

      .pos-sticky .controls{
        align-items: flex-start;
      }
      .pos-sticky .left{
        width: 100%;
        gap: 8px;
      }
      .pos-sticky .left > *{
        flex: 0 0 auto;
      }
      .pos-sticky .right{
        width: 100%;
        justify-content: flex-start;
      }
      .pos-sticky .right .btn-large{
        width: 100%;
      }
    }

    @media (min-width: 601px){
      /* mantener la misma altura vertical para cada card */
      .card-carrito{ height: calc(100vh - 220px); }
      .card-pagos{ height: calc(100vh - 220px); }
    }

    @media (max-width: 600px){
      .card-carrito, .card-pagos{ height:auto; }
      .card-carrito .card-body{ max-height: 260px; }
      .card-pagos .card-body{ max-height: 340px; }
      .card-carrito .card-head-actions{
        width: 100%;
      }
      .card-carrito .card-head-actions #btn_open_buscar,
      .card-carrito .card-head-actions form{
        width: 100%;
      }
      .card-carrito .card-head-actions form button{
        width: 100%;
      }
      .card-carrito .card-head-actions .pos-scan-input{
        width: 100%;
        flex-basis: 100%;
      }
      .card-pagos .card-head-actions{
        width: 100%;
      }
      .card-pagos .card-head-actions form{
        width: 100%;
      }
      .card-pagos .card-head-actions form button{
        width: 100%;
      }
      .pos-sticky .left{
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      .pos-sticky .left .chip{
        margin: 0;
      }
    }

    /* Selects */
    .select-wrapper input.select-dropdown{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pagos-select .select-wrapper input.select-dropdown{
      padding-right: 2.2rem !important;
      box-sizing:border-box;
    }
    .pagos-select .select-wrapper .caret{ right:.5rem; }

    /* Barra sticky inferior */
    .pos-sticky{
      position: sticky;
      bottom: 0;
      z-index: 999;
      border-top: 1px solid var(--pos-divider);
      background: var(--pos-card-bg);
      border: 1px solid var(--pos-card-border);
      border-radius: var(--pos-radius-lg);
      box-shadow: var(--pos-shadow-card);
    }
    .pos-sticky .card-content{ padding: 12px 16px; }
    .pos-sticky .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin:0;
    }
    .pos-sticky .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pos-sticky .right{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .touch-btn{ height:48px; line-height:48px; }
    .chip.sucursal-chip{ font-weight:600; }
    @media (max-width: 600px){
      .pos-sticky .controls{ gap:10px; }
      .pos-sticky .right{ width:100%; justify-content:stretch; }
      .pos-sticky .right .btn-large{ width:100%; }
    }

    /* =======================
       NAV POS (pro)
    ======================= */
    .pos-nav{
      background: linear-gradient(180deg, var(--pos-nav-bg) 0%, var(--pos-nav-bg-2) 100%);
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .pos-nav .brand-logo{
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1 !important;
      height: auto !important;
      padding: 8px 0;
      overflow: visible;
    }
    .pos-nav .brand-logo .brand-mark{
      width: 50px;
      height: 50px;
      object-fit: contain;
      border-radius: 12px;
      flex: 0 0 auto;
      display:block;
      box-shadow: 0 4px 10px rgba(40, 20, 8, 0.18);
      background: rgba(255,255,255,.10);
      padding: 1px;
    }
    .pos-nav .brand-logo .brand-copy{
      display:flex;
      flex-direction:column;
      justify-content:center;
      line-height:1;
      gap:2px;
    }
    .pos-nav .brand-logo .brand-name{
      font-size: 17px;
      font-weight: 800;
      letter-spacing: .3px;
      color: #fff;
    }
    .pos-nav .brand-logo .brand-caption{
      font-size: 10px;
      opacity: .84;
      color: #fff;
      font-weight: 600;
      letter-spacing: .25px;
    }
    .pos-nav .nav-badge{
      font-size: 12px;
      opacity: .85;
      margin-left: 6px;
      font-weight: 600;
    }
    .pos-nav .nav-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.15);
      border-color: var(--pos-nav-border);
      border-radius:999px;
      font-size:12px;
      line-height:1;
      color:#fff;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .pos-nav .nav-chip i{ font-size:18px; }
    .pos-nav .nav-actions a{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pos-nav .btn-flat{
      color:#fff;
    }
    .pos-nav .btn-flat:hover{
      background: var(--pos-nav-hover);
    }

    .dropdown-content{
      border-radius:10px;
      overflow:hidden;
    }
    .dropdown-content li>a, .dropdown-content li>span{
      font-size:14px;
    }

    .pos-nav .nav-wrapper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      min-height: 64px;
    }
    .pos-nav .brand-logo{
      position: static !important;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .pos-nav ul.right{
      position: static !important;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:nowrap;
      flex:0 0 auto;
      min-width:0;
    }
    .pos-nav ul.right .btn-flat,
    .pos-nav ul.right .nav-chip{
      white-space:nowrap;
      flex-shrink:0;
    }
    .pos-nav i.material-icons{
      text-transform:none !important;
    }

    @media (max-width: 1280px){
      #nav_clock{ display:none; }
      #nav_date{ display:none; }
      .pos-nav .brand-logo .brand-caption{ display:none; }
    }
    @media (max-width: 1180px){
      .pos-nav .nav-badge{ display:none; }
    }
    /* =======================
       Buscar modal styles — estética
    ======================= */
    /* Contenedor del modal centrado y con ancho más contenido */
    #buscar_modal.modal{
      max-width: 900px;
      width: 85% !important;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.18);
      overflow: visible !important;
    }

    /* Hacemos que el contenido del modal sea transparente y dejamos la tarjeta como el visual principal */
    #buscar_modal .modal-content{
      overflow: hidden !important;
      padding: 0;
      background: transparent;
      display: flex;
      flex-direction: column;
    }

    /* Card interior: borde suave, esquinas y recorte */
    #buscar_modal .card.pos-card{
      margin: 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: none;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* Encabezado fijo y con padding uniforme */
    #buscar_modal .card-head{
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 6;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    #buscar_modal .card-head .card-title{ margin:0; font-size:18px; }

    /* Input y espacio alrededor */
    #buscar_modal .input-field{ margin: 0; padding: 0 16px 8px 16px; background: #fff; }

    /* Solo el cuerpo de resultados es scrollable */
    #buscar_modal .card-body{
      overflow-y: auto !important;
      max-height: calc(70vh - 120px);
      padding: 8px 16px 16px 16px;
      background: #fff;
    }

    /* Ajustes de items para una lectura más clara */
    #buscar_modal .collection-item{ padding: 10px 12px; }
    #buscar_modal .select-wrapper input.select-dropdown{ padding-left:8px; }

    /* Footer del modal alineado al modal de pagos */
    #buscar_modal .modal-footer{
      background: #fff;
      border-top: 1px solid rgba(0,0,0,.08);
      padding: 10px 24px;
    }
    #buscar_modal_scroll{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
    }
    /* =======================
       Modal Buscar / Pagos (estilo POS real)
    ======================= */
    #buscar_modal.modal,
    #pago_modal.modal{
      left: 0 !important;
      right: 0 !important;
      margin-left: auto !important;
      margin-right: auto !important;
      border-radius: 14px;
      overflow: hidden !important;
      background: var(--pos-card-bg);
      border: 1px solid rgba(121, 85, 72, 0.14);
      box-shadow: 0 16px 40px rgba(80, 52, 40, 0.18);
    }
    #pago_modal.modal{
      max-width: 1080px;
      width: 92% !important;
    }
    #buscar_modal .modal-content,
    #pago_modal .modal-content{
      background:
        radial-gradient(circle at top right, rgba(255,255,255,.65), rgba(255,255,255,0) 48%),
        var(--pos-card-bg);
      padding: 12px 12px 0;
    }
    #pago_modal #pago_modal_content{
      overflow: auto;
      background: transparent;
    }
    #buscar_modal .modal-footer,
    #pago_modal .modal-footer{
      background: linear-gradient(180deg, rgba(242,224,212,.9), rgba(247,238,232,.95));
      border-top: 1px solid rgba(121, 85, 72, 0.12);
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
    }
    #buscar_modal .modal-footer .btn,
    #pago_modal .modal-footer .btn,
    #buscar_modal .modal-footer .btn-flat,
    #pago_modal .modal-footer .btn-flat{
      border-radius: 10px;
    }
    #buscar_modal > .modal-content > .white,
    #pago_modal #pago_modal_content > .white{
      background: transparent !important;
    }

    /* Bloques sticky internos de ambos modales con lenguaje de card-head */
    #buscar_modal .white > .row > .col > .card-panel,
    #pago_modal .white > .row > .col > .card-panel{
      background: var(--pos-card-head) !important;
      border: 1px solid rgba(121, 85, 72, 0.10) !important;
      border-radius: var(--pos-radius-md);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }

    /* Modal de búsqueda: resultados dentro de panel POS */
    #buscar_modal_scroll{
      padding-top: 10px !important;
    }
    #buscar_modal_resultados{
      padding: 10px 12px 12px !important;
      border-radius: var(--pos-radius-md);
      border: 1px solid rgba(121, 85, 72, 0.10);
      background: rgba(255,255,255,.52);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    #buscar_modal #buscar_modal_resultados .collection{
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(121, 85, 72, 0.10);
      background: #fff;
      margin: 0;
    }
    #buscar_modal #buscar_modal_resultados .collection .collection-item{
      background: rgba(255,255,255,.92);
      border-bottom: 1px solid rgba(121, 85, 72, 0.08);
    }
    #buscar_modal #buscar_modal_resultados .collection .collection-item:last-child{
      border-bottom: none;
    }
    #buscar_modal .input-field{
      border-radius: 10px;
    }
    #buscar_modal .input-field input[type=text]{
      border-bottom-color: rgba(121, 85, 72, 0.18) !important;
    }
    #buscar_modal .progress{
      background: rgba(0,150,136,.12);
      border-radius: 999px;
      overflow: hidden;
    }

    /* Modal de pagos: paneles, chips y cuerpo alineados al POS */
    #pago_modal #pagos_modal_body{
      padding-top: 10px !important;
      padding-bottom: 4px !important;
    }
    #pago_modal #pagos_modal_body > .card-panel.grey.lighten-4{
      background: rgba(255,255,255,.58) !important;
    }
    #pago_modal .chip{
      border: 1px solid rgba(121, 85, 72, 0.08);
      border-radius: 999px;
    }
    #pago_modal .btn,
    #pago_modal .btn-flat{
      border-radius: 10px;
    }
    #pago_modal .input-field input[type=text],
    #pago_modal .select-wrapper input.select-dropdown{
      border-bottom-color: rgba(121, 85, 72, 0.18);
    }
    #pago_modal .progress{
      border-radius: 999px;
      overflow: hidden;
    }
    @media (max-width: 600px){
      #buscar_modal.modal,
      #pago_modal.modal{
        width: 95% !important;
      }
      #buscar_modal .modal-content,
      #pago_modal .modal-content{
        padding: 10px 10px 0;
      }
      #buscar_modal .modal-footer,
      #pago_modal .modal-footer{
        padding: 10px 12px;
      }
    }
    .pos-shell-card{
      margin: 0;
      padding: 14px 14px 10px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: var(--pos-shadow-soft);
      background: var(--pos-warm-shell);
    }
    .pos-shell-card > .row{ margin-bottom: 0; }
    .pos-shell-card .pos-sticky{ margin-top: 6px; }
    .last-sale-rail{
      position: fixed;
      top: 74px;
      left: 16px;
      width: 250px;
      z-index: 20;
    }
    .last-sale-rail .card{
      margin: 0;
      border-radius: var(--pos-radius-lg);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: var(--pos-shadow-soft);
    }
    #buscar_modal .card-panel,
    #pago_modal .card-panel{
      border-radius: var(--pos-radius-md);
      border: 1px solid rgba(121, 85, 72, 0.10);
      box-shadow: 0 6px 18px rgba(106, 68, 51, 0.07);
    }
    .last-sale-rail .card-content{
      padding: 14px 14px 10px;
    }
    .last-sale-rail .rail-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:#263238;
      margin-bottom:10px;
    }
    .last-sale-rail .rail-kpi{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
      border-bottom:1px dashed rgba(0,0,0,.06);
      font-size:13px;
    }
    .last-sale-rail .rail-kpi:last-of-type{
      border-bottom:none;
    }
    .last-sale-rail .rail-list{
      margin:8px 0 0;
      border-top:1px solid rgba(0,0,0,.06);
      padding-top:8px;
    }
    .last-sale-rail .rail-item{
      font-size:12px;
      line-height:1.25;
      padding:4px 0;
      color:#37474f;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .last-sale-rail .rail-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .last-sale-rail .rail-actions .btn,
    .last-sale-rail .rail-actions .btn-flat{
      flex:1 1 auto;
      text-align:center;
    }
    @media (max-width: 1700px){
      .last-sale-rail{ display:none; }
    }
    @media (max-width: 600px){
      .pos-shell-card{ padding: 10px 10px 8px; }
    }
    /* POS container más ancho para aprovechar espacio lateral en pantallas grandes */
    .pos-container{ max-width:1400px; }
  </style>
</head>

<body style="background: var(--pos-warm-bg);">

  {% if last_sale %}
    <aside class="last-sale-rail hide-on-med-and-down" aria-label="Resumen de última venta">
      <div class="card white">
        <div class="card-content">
          <div class="rail-title">
            <i class="material-icons teal-text text-darken-1">receipt_long</i>
            <span>Última venta</span>
          </div>

          <div class="grey-text text-darken-1" style="font-size:12px; margin-bottom:8px;">
            {{ last_sale.codigo_sucursal }} · {{ last_sale.fecha|date:"d/m H:i" }}
          </div>

          <div class="rail-kpi">
            <span class="grey-text text-darken-1">Sucursal</span>
            <strong>{{ last_sale.sucursal.nombre }}</strong>
          </div>
          <div class="rail-kpi">
            <span class="grey-text text-darken-1">Ítems</span>
            <strong>{{ last_sale.items.count }}</strong>
          </div>
          <div class="rail-kpi">
            <span class="grey-text text-darken-1">Pagos</span>
            <strong>{{ last_sale_pagos|length }}</strong>
          </div>
          <div class="rail-kpi">
            <span class="grey-text text-darken-1">Total ítems</span>
            <strong>${{ last_sale_total_items|num_ar }}</strong>
          </div>
          <div class="rail-kpi" style="border-bottom:none;">
            <span class="grey-text text-darken-1">Total final</span>
            <strong class="teal-text text-darken-2">${{ last_sale_total_final|num_ar }}</strong>
          </div>

          <div class="rail-list">
            {% for it in last_sale.items.all|slice:":3" %}
              <div class="rail-item">
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ it.variante.sku }}</span>
                <strong>x{{ it.cantidad }}</strong>
              </div>
            {% empty %}
              <div class="grey-text" style="font-size:12px;">Sin ítems</div>
            {% endfor %}
            {% if last_sale.items.count > 3 %}
              <div class="grey-text" style="font-size:11px; margin-top:2px;">
                +{{ last_sale.items.count|add:"-3" }} ítems más
              </div>
            {% endif %}
          </div>

          <div class="rail-actions">
            <a href="{% url 'caja:ticket' last_sale.id %}?print=1" target="_blank" rel="noopener" class="btn green darken-1 waves-effect waves-light">
              <i class="material-icons left">print</i>Ticket
            </a>
          </div>
        </div>
      </div>
    </aside>
  {% endif %}

  <!-- NAV -->
  <nav class="pos-nav z-depth-1">
    <div class="nav-wrapper container">
      <a href="{% url 'caja:pos' %}" class="brand-logo">
        <img class="brand-mark" src="{% static 'branding/vgc-favicon.svg' %}" alt="VGC">
        <span class="brand-copy">
          <span class="brand-name">VGC</span>
          <span class="brand-caption">Sistema de Ventas</span>
        </span>
      </a>

      <a href="#" data-target="mobile_nav" class="sidenav-trigger">
        <i class="material-icons">menu</i>
      </a>

      <ul class="right hide-on-med-and-down nav-actions">
        <li>
          <a class="btn-flat waves-effect" href="{% url 'core:dashboard' %}">
            <i class="material-icons">dashboard</i>
            Dashboard
          </a>
        </li>

        <li>
          <a class="btn-flat waves-effect" href="{% url 'caja:pos' %}">
            <i class="material-icons">point_of_sale</i>
            Caja
          </a>
        </li>

        {% if request.user.is_superuser or perms.admin_panel.view_usuarioperfil %}
          <li>
            <a class="btn-flat waves-effect" href="{% url 'admin_panel:dashboard' %}">
              <i class="material-icons">admin_panel_settings</i>
              Admin Panel
            </a>
          </li>
        {% endif %}
        <li>
          <span class="nav-chip">
            <i class="material-icons">store</i>
            {{ sucursal.nombre }}
          </span>
        </li>
        <li>
          <span class="nav-chip" id="nav_date">
            <i class="material-icons">calendar_today</i>
            --/--/----
          </span>
        </li>

        <li>
          <span class="nav-chip" id="nav_clock">
            <i class="material-icons">schedule</i>
            --:--
          </span>
        </li>

        <li>
          <a class="dropdown-trigger btn-flat waves-effect" href="#!" data-target="user_dd">
            <i class="material-icons">account_circle</i>
            {{ request.user.username|default:"Usuario" }}
            <i class="material-icons right">arrow_drop_down</i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <ul id="user_dd" class="dropdown-content">
    <li><a href="{% url 'password_change' %}"><i class="material-icons">lock</i>Cambiar clave</a></li>
    <li class="divider" tabindex="-1"></li>
    <li>
      <a href="{% url 'logout' %}" onclick="event.preventDefault(); document.getElementById('pos_logout_form').submit();">
        <i class="material-icons">logout</i>Salir
      </a>
    </li>
  </ul>

  <form id="pos_logout_form" method="post" action="{% url 'logout' %}" style="display:none;">
    {% csrf_token %}
  </form>

  <ul class="sidenav" id="mobile_nav">
    <li>
      <div class="user-view" style="background:#0f172a;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
          <img src="{% static 'branding/vgc-badge.svg' %}" alt="VGC" style="width:52px; height:34px; object-fit:contain; border-radius:8px;">
          <div>
            <div class="white-text" style="font-weight:800; line-height:1.1;">VGC</div>
            <div class="white-text" style="opacity:.85; font-size:12px; line-height:1.1;">Sistema de Ventas</div>
          </div>
        </div>
        <span class="white-text" style="opacity:.85;">{{ sucursal.nombre }}</span>
        <span class="white-text" style="opacity:.85;">{{ request.user.username|default:"Usuario" }}</span>
      </div>
    </li>
    <li><a href="{% url 'core:dashboard' %}"><i class="material-icons">dashboard</i>Dashboard</a></li>
    <li><a href="{% url 'caja:pos' %}"><i class="material-icons">point_of_sale</i>Caja</a></li>
    {% if request.user.is_superuser or perms.admin_panel.view_usuarioperfil %}
      <li><a href="{% url 'admin_panel:dashboard' %}"><i class="material-icons">admin_panel_settings</i>Admin Panel</a></li>
    {% endif %}
    <li>
      <a href="{% url 'logout' %}" onclick="event.preventDefault(); document.getElementById('pos_logout_form').submit();">
        <i class="material-icons">logout</i>Salir
      </a>
    </li>
  </ul>

  <div class="container pos-container" style="margin-top:18px;">
    <div class="card pos-shell-card">
      <div class="card-panel" style="margin:0 0 12px; border-radius:12px; border:1px solid rgba(121,85,72,.12); background:rgba(255,255,255,.55);">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div style="min-width:260px; flex:1 1 360px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              {% if caja_activa %}
                {% if caja_puede_vender %}
                  <span class="chip green lighten-4 green-text text-darken-3" style="font-weight:600;">Caja abierta (tuya)</span>
                {% else %}
                  <span class="chip orange lighten-4 orange-text text-darken-4" style="font-weight:600;">Caja abierta (otro cajero)</span>
                {% endif %}
              {% else %}
                <span class="chip red lighten-4 red-text text-darken-3" style="font-weight:600;">Caja cerrada</span>
              {% endif %}
              {% if caja_cajero_activo %}
                <span class="chip" style="font-weight:500;">
                  Cajero: {{ caja_cajero_activo.get_full_name|default:caja_cajero_activo.username }}
                </span>
              {% endif %}
            </div>

            <div class="grey-text text-darken-2" style="font-size:13px; margin-top:4px;">
              {{ caja_estado_texto }}
            </div>

            {% if caja_cierre_resumen %}
              <div class="teal-text text-darken-3" style="font-size:13px; margin-top:6px; font-weight:500;">
                Cierre registrado: {{ caja_cierre_resumen.cantidad }} ventas por ${{ caja_cierre_resumen.total|num_ar }}
              </div>
            {% endif %}
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            {% if not caja_activa %}
              <form method="post"
                    action="{% url 'caja:caja_abrir' %}"
                    hx-post="{% url 'caja:caja_abrir' %}"
                    hx-swap="none"
                    style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn green darken-1 waves-effect waves-light">
                  <i class="material-icons left">lock_open</i>Abrir caja
                </button>
              </form>
            {% elif caja_puede_vender %}
              <form method="post"
                    action="{% url 'caja:caja_cerrar' %}"
                    hx-post="{% url 'caja:caja_cerrar' %}"
                    hx-swap="none"
                    style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn red darken-1 waves-effect waves-light">
                  <i class="material-icons left">lock</i>Cerrar caja
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card-panel" style="margin:0 0 12px; border-radius:12px; border:1px dashed rgba(121,85,72,.18); background:rgba(255,255,255,.62);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div class="grey-text text-darken-2" style="font-size:13px; font-weight:600;">
            Atajos de teclado
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <span class="chip" style="margin:0; font-weight:600;">
              <span class="mono" style="font-weight:800;">F1</span>&nbsp;Buscar
            </span>
            <span class="chip" style="margin:0; font-weight:600;">
              <span class="mono" style="font-weight:800;">F2</span>&nbsp;Pagos
            </span>
            <span class="chip" style="margin:0; font-weight:600;">
              <span class="mono" style="font-weight:800;">F5</span>&nbsp;Confirmar venta
            </span>
          </div>
        </div>
      </div>

      <div class="row">

      <!-- Columna 1: Carrito -->
      <div class="col s12 m6 l7">
        <div class="card pos-card card-carrito">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Carrito</span>

                <div class="card-head-actions">

                  <button id="btn_open_buscar" type="button" class="btn blue darken-1 waves-effect waves-light" style="margin-right:8px;" title="Buscar productos (F1)" {% if not caja_puede_vender %}disabled{% endif %}>
                    <i class="material-icons left">search</i>Buscar
                  </button>

                  <input id="scan_reader_input"
                         type="text"
                         class="browser-default pos-scan-input"
                         autocomplete="off"
                         autocapitalize="off"
                         spellcheck="false"
                         inputmode="none"
                         placeholder="{% if caja_puede_vender %}Escanear código (lector){% else %}Caja no habilitada para vender{% endif %}"
                         aria-label="Escaneo rápido por lector de código de barras"
                         title="Solo lecturas por lector (rápidas + Enter)"
                         {% if not caja_puede_vender %}disabled{% endif %}>

                  <form hx-post="{% url 'caja:carrito_vaciar' %}"
                        hx-target="#carrito_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button class="btn red lighten-1 waves-effect waves-light" type="submit" {% if not caja_puede_vender %}disabled{% endif %}>
                      Vaciar
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <div class="card-body" id="carrito_scroll">
              <div id="carrito_body">
                {% include "caja/_carrito.html" with items=cart_items total=cart_total %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Columna 2: Pagos -->
      <div class="col s12 m6 l5">
        <div class="card pos-card card-pagos">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Pagos</span>

                <div class="card-head-actions">
                  {# ✅ POST con CSRF (si lo hacés con button suelto, Django te tira 403) #}
                  <form hx-post="{% url 'caja:pagos_add_modal' %}"
                        hx-target="#pagos_modal_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button id="btn_open_pagos"
                            type="button"
                            class="btn green darken-1 waves-effect waves-light"
                            hx-post="{% url 'caja:pagos_modal_open' %}"
                            hx-target="#pago_modal_content"
                            hx-swap="innerHTML"
                            title="Abrir pagos (F2)"
                            {% if not caja_puede_vender %}disabled{% endif %}>
                      <i class="material-icons left">add</i>AGREGAR
                    </button>

                  </form>

                  <form hx-post="{% url 'caja:pagos_vaciar_table' %}"
                        hx-swap="none"
                        style="margin:0;">
                    {% csrf_token %}
                    <button class="btn red lighten-1 waves-effect waves-light" type="submit" {% if not caja_puede_vender %}disabled{% endif %}>
                      Vaciar
                    </button>
                  </form>
                </div>
              </div>

              <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,.08);">
                <div id="pagos_totales" style="margin-top:0;">
                  {% include "caja/_pagos_totales.html" %}
                </div>
              </div>
            </div>

            <div class="card-body" id="pagos_scroll">
              <div id="pagos_table">
                {% include "caja/_pagos_table.html" with payments=payments %}
              </div>
            </div>

          </div>
        </div>
      </div>

      </div><!-- /row -->

      <!-- Barra sticky inferior (Confirmación) -->
      <div class="card pos-sticky">
        <div class="card-content">
          <form
            id="confirm_venta_form"
            hx-post="{% url 'caja:confirmar' %}"
            hx-target="#confirm_res"
            hx-swap="innerHTML"
            hx-target-error="#confirm_res"
          >
            {% csrf_token %}
            <input id="confirm_token_input" type="hidden" name="confirm_token" value="{{ confirm_token }}">

            <div class="controls">
              <div class="left">
                <span class="grey-text text-darken-1">Sucursal</span>
                <div class="chip sucursal-chip">{{ sucursal.nombre }}</div>

                <span class="grey-text text-darken-1">
                  Total a cobrar: $<strong id="total_cobrar_confirm">{{ total_cobrar|num_ar }}</strong>
                </span>
              </div>

              <div class="right">
                <button id="confirm_venta_btn" class="btn-large waves-effect waves-light green touch-btn" type="submit" title="Confirmar venta (F5)" {% if not caja_puede_vender %}disabled{% endif %}>
                  {% if caja_puede_vender %}Confirmar venta{% else %}Caja no habilitada{% endif %}
                </button>
              </div>
            </div>
          </form>

          <div id="confirm_res" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Modal Buscar (mejorado) -->
<div id="buscar_modal" class="modal modal-fixed-footer">
  <!-- Header sticky -->
  <div class="modal-content" style="padding-top:0;">
    <div class="white"
         style="position:sticky; top:0; z-index:10; padding:12px 0 10px; border-bottom:1px solid rgba(0,0,0,.08);">
      <div class="row" style="margin:0;">
        <div class="col s12">
          <div class="card-panel" style="margin:0; padding:14px 16px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">
              <div style="min-width:240px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(0,150,136,0.08);">
                    <i class="material-icons teal-text" style="font-size:22px;">search</i>
                  </div>
                  <div>
                    <h4 style="margin:0; font-weight:700; font-size:18px;">Buscador de productos</h4>
                    <div class="grey-text" style="font-size:12px; margin-top:4px;">Encontrá variantes por SKU, nombre o código de barras.</div>
                  </div>
                </div>
              </div>

              <a href="#!" class="modal-close btn-flat" title="Cerrar" style="padding:0 10px;">
                <i class="material-icons">close</i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="white"
         style="position:sticky; top:94px; z-index:9; padding:0 0 10px;">
      <div class="row" style="margin:0;">
        <div class="col s12">
          <div class="card-panel" style="margin:0; padding:12px 16px;">
            <div class="input-field" style="margin:0; background:#fff; border:1px solid rgba(0,0,0,.10); border-radius:10px; padding:4px 12px 0 12px; position:relative;">
              <i class="material-icons prefix teal-text text-darken-1">search</i>

              <!-- ✅ ID único (evita conflicto con el input principal del POS) -->
              <input id="q_modal" name="q" type="text"
                     autocomplete="off"
                     inputmode="search"
                     placeholder="SKU, nombre o código de barras…"
                     hx-get="{% url 'caja:buscar' %}"
                     hx-trigger="keyup changed delay:250ms"
                     hx-target="#buscar_modal_resultados"
                     hx-swap="innerHTML"
                     hx-sync="#buscar_modal:queue"
                     hx-indicator="#buscar_modal_spinner">

              <!-- Botón limpiar -->
              <a href="#!" id="q_modal_clear"
                 class="btn-flat"
                 style="position:absolute; right:8px; top:4px; height:48px; line-height:48px;"
                 title="Limpiar">
                <i class="material-icons grey-text">backspace</i>
              </a>
            </div>

            <!-- Indicador (spinner) -->
            <div id="buscar_modal_spinner" class="progress" style="margin:6px 0 0; display:none;">
              <div class="indeterminate"></div>
            </div>

            <div class="grey-text" style="font-size:12px; margin-top:8px;">
              Tip: podés pegar el código o escanear con lector USB.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Body (scroll) -->
    <div id="buscar_modal_scroll" style="padding-top:12px;">
      <div id="buscar_modal_resultados" style="padding:0 16px 12px;">
        {% include "caja/_resultados.html" with results=None %}
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <a href="#!" class="btn green darken-1 waves-effect waves-light modal-close">
      <i class="material-icons left">check</i>Aplicar
    </a>
  </div>
</div>
  <!--{# =======================
     Modal Pagos
  ======================= #}-->
    <div id="pago_modal" class="modal modal-fixed-footer">
    <div class="modal-content" id="pago_modal_content">
      <!-- HTMX inyecta SOLO el body acá -->
    </div>

    <div class="modal-footer">
      

      <a href="#!" class="btn blue waves-effect waves-light modal-close">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>
  </div>

  <!--{# =======================
     Modal Venta (post-confirm)
  ======================= #}-->
  {% if last_sale %}
    <div id="venta_modal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h5 class="venta-modal-title">{{ last_sale.codigo_sucursal }}</h5>

        <div class="grey-text venta-modal-meta">
          {{ last_sale.fecha|date:"d/m/Y H:i" }} — {{ last_sale.sucursal.nombre }}
        </div>

        <h6 class="venta-section-title">Items</h6>
        <div class="venta-soft-panel">
          <table class="striped venta-items-table" style="font-size:13px;">
            <thead>
              <tr>
                <th style="width:50%;">Producto</th>
                <th style="width:12%;">Cant.</th>
                <th class="right-align" style="width:19%;">Unit.</th>
                <th class="right-align" style="width:19%;">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% for it in last_sale.items.all %}
                <tr>
                  <td>
                    <div style="font-weight:600; line-height:1.2;">{{ it.variante.sku }}</div>
                    <div class="grey-text" style="font-size:12px; line-height:1.2;">
                      {{ it.variante.producto.nombre }}
                    </div>
                  </td>
                  <td>{{ it.cantidad }}</td>
                  <td class="right-align">${{ it.precio_unitario|num_ar }}</td>
                  <td class="right-align"><strong>${{ it.subtotal|num_ar }}</strong></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="venta-subtotal-line" style="text-align:right;">
            <span class="grey-text text-darken-2">Total por items:</span>
            <strong>${{ last_sale_total_items|num_ar }}</strong>
          </div>
        </div>

        <h6 class="venta-section-title">Formas de pago</h6>
        <div class="venta-soft-panel">
          <ul class="collection venta-payments-list">
            {% for p in last_sale_pagos %}
              <li class="collection-item" style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
                <div>
                  <div style="font-weight:600;">{{ p.get_tipo_display }}</div>

                  {% if p.tipo == "CREDITO" %}
                    <div class="grey-text venta-payment-meta">
                      {% if p.plan %}{{ p.plan.tarjeta }} — {% endif %}
                      {{ p.cuotas }} cuotas
                      {% if p.recargo_pct|add:0 > 0 %} — Recargo {{ p.recargo_pct|num_ar }}%{% endif %}
                    </div>
                  {% endif %}

                  

                  {% if p.tipo == "CUENTA_CORRIENTE" and p.referencia %}
                    <div class="grey-text venta-payment-ref">
                      {{ p.referencia|cut:"Cuenta corriente — "|cut:"Cuenta corriente - " }}
                    </div>
                  {% elif p.referencia %}
                    <div class="grey-text venta-payment-ref">Ref: {{ p.referencia }}</div>
                  {% endif %}
                </div>

                <div class="venta-payment-amount">
                  <strong>${{ p.monto|num_ar }}</strong>
                  {% if p.tipo == "CREDITO" and p.recargo_calc|add:0 > 0 %}
                    <div class="grey-text venta-payment-extra">Recargo: +${{ p.recargo_calc|num_ar }}</div>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>

          <div class="venta-total-line" style="text-align:right;">
            <span class="grey-text text-darken-2">Total venta:</span>
            <strong style="font-size:18px;">
              {{ last_sale_total_final|num_ar }}
            </strong>
          </div>
        </div>

      </div>

      <div class="modal-footer venta-modal-footer">
      

      <a href="#!" class="modal-close btn-flat">Cerrar</a>
      <a href="{% url 'caja:ticket' last_sale.id %}?print=1"
        target="_blank" rel="noopener"
        class="btn blue waves-effect waves-light"
        onclick="closeVentaModalAndFocus();">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>

    </div>
  {% endif %}

  <script>
    // =========================
    // Utils
    // =========================
    function initSelects(root){
      if (!window.M || !M.FormSelect) return;
      var elems = (root || document).querySelectorAll('select');
      M.FormSelect.init(elems);
    }

    function initNav(){
      if (!window.M) return;

      const dd = document.querySelectorAll('.dropdown-trigger');
      M.Dropdown.init(dd, { coverTrigger:false, constrainWidth:false });

      const sidenavs = document.querySelectorAll('.sidenav');
      M.Sidenav.init(sidenavs);

      const el = document.getElementById("nav_clock");
      const dateEl = document.getElementById("nav_date");
      function tick(){
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mo = String(d.getMonth() + 1).padStart(2,'0');
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        if (dateEl) {
          dateEl.innerHTML = '<i class="material-icons">calendar_today</i> ' + dd + '/' + mo + '/' + yy;
        }
        if (el) {
          el.innerHTML = '<i class="material-icons">schedule</i> ' + hh + ':' + mm;
        }
      }
      tick();
      setInterval(tick, 10000);
    }

    function centerVentaModal(){
      const modalEl = document.getElementById("venta_modal");
      if (!modalEl) return;

      modalEl.style.position = "fixed";

      const w = modalEl.offsetWidth || 0;
      const left = Math.max((window.innerWidth - w) / 2, 12);

      modalEl.style.left = left + "px";
      modalEl.style.right = "auto";
    }

    function centerUiModal(modalEl){
      if (!modalEl) return;
      modalEl.style.position = "fixed";
      modalEl.style.left = "0";
      modalEl.style.right = "0";
      modalEl.style.marginLeft = "auto";
      modalEl.style.marginRight = "auto";
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    // =========================
    // DOM Ready
    // =========================
    document.addEventListener('DOMContentLoaded', function() {
      initSelects(document);
      initNav();

      // Modal pagos
      const pagoModalEl = document.getElementById('pago_modal');
      if (pagoModalEl && window.M && M.Modal) {
        M.Modal.init(pagoModalEl, {
          dismissible: true,
          onOpenStart: () => centerUiModal(pagoModalEl),
          onOpenEnd: () => centerUiModal(pagoModalEl)
        });
        centerUiModal(pagoModalEl);
      }

      // Modal Buscar: init + focus + limpiar + botón abrir
      const buscarModalEl = document.getElementById('buscar_modal');
      if (buscarModalEl && window.M && M.Modal) {
        M.Modal.init(buscarModalEl, {
          dismissible: true,
          onOpenStart: () => {
            centerUiModal(buscarModalEl);
            setTimeout(() => {
              const q = document.getElementById('q_modal');
              if (q) q.focus();
            }, 50);
          },
          onOpenEnd: () => centerUiModal(buscarModalEl)
        });
        centerUiModal(buscarModalEl);
      }

      const openBuscarBtn = document.getElementById('btn_open_buscar');
      if (openBuscarBtn) {
        openBuscarBtn.addEventListener('click', function () {
          if (!buscarModalEl || !window.M || !M.Modal) return;
          centerUiModal(buscarModalEl);
          const inst = M.Modal.getInstance(buscarModalEl) || M.Modal.init(buscarModalEl, { dismissible:true });
          inst.open();
          setTimeout(() => centerUiModal(buscarModalEl), 40);
        });
      }

      const clearBtn = document.getElementById('q_modal_clear');
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const q = document.getElementById('q_modal');
          if (!q) return;
          q.value = '';
          q.focus();
          // opcional: limpiar resultados al limpiar input (si querés)
          // document.getElementById('buscar_modal_resultados').innerHTML = '';
        });
      }

    // Si HTMX reinyecta el contenido del modal en algún momento, re-enfocá
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'buscar_modal_resultados') {
        const wrap = document.getElementById('buscar_modal_scroll');
        if (wrap) wrap.scrollTop = 0;
      }
    });

      // Modal venta
      const ventaModalEl = document.getElementById('venta_modal');
      if (ventaModalEl && window.M && M.Modal) {
        const inst = M.Modal.init(ventaModalEl, {
          dismissible: true,
          onOpenEnd: centerVentaModal
        });

        inst.open();
        setTimeout(centerVentaModal, 0);
        setTimeout(centerVentaModal, 50);
        window.addEventListener("resize", centerVentaModal);
      }

      window.addEventListener("resize", function(){
        centerUiModal(buscarModalEl);
        centerUiModal(pagoModalEl);
      });

      // Barra rápida de lector (solo acepta ráfagas de teclas típicas de escáner + Enter)
      const scanReaderInput = document.getElementById("scan_reader_input");
      if (scanReaderInput) {
        let scanBurst = { startedAt: 0, lastAt: 0, keyCount: 0 };

        function resetScanBurst() {
          scanBurst = { startedAt: 0, lastAt: 0, keyCount: 0 };
        }

        scanReaderInput.addEventListener("paste", function (e) {
          e.preventDefault();
        });

        scanReaderInput.addEventListener("keydown", function (e) {
          const now = (window.performance && performance.now) ? performance.now() : Date.now();

          if (e.key === "Enter") {
            e.preventDefault();
            const q = scanReaderInput.value.trim();
            if (!q) {
              resetScanBurst();
              return;
            }

            const duration = (scanBurst.startedAt && scanBurst.lastAt) ? (scanBurst.lastAt - scanBurst.startedAt) : 9999;
            const looksLikeScanner = scanBurst.keyCount >= 6 && duration <= 350;

            if (!looksLikeScanner) {
              scanReaderInput.value = "";
              resetScanBurst();
              return;
            }

            htmx.ajax("POST", "{% url 'caja:scan_add' %}", {
              target: "#carrito_body",
              swap: "innerHTML",
              values: { q },
              headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            scanReaderInput.value = "";
            resetScanBurst();
            return;
          }

          if (e.key === "Tab") {
            resetScanBurst();
            return;
          }

          if (e.ctrlKey || e.altKey || e.metaKey) return;

          if (e.key.length === 1) {
            if (!scanBurst.lastAt || (now - scanBurst.lastAt) > 120) {
              scanBurst.startedAt = now;
              scanBurst.keyCount = 0;
            }
            scanBurst.lastAt = now;
            scanBurst.keyCount += 1;
          }
        });

        scanReaderInput.addEventListener("blur", resetScanBurst);
      }
    });

    // Abrir/cerrar modal pagos vía triggers
    document.body.addEventListener("openPagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      centerUiModal(el);
      const inst = M.Modal.getInstance(el) || M.Modal.init(el, { dismissible:true });
      inst.open();
      setTimeout(() => centerUiModal(el), 40);
    });

    document.body.addEventListener("closePagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      const inst = M.Modal.getInstance(el);
      if (inst) inst.close();
    });

    // =========================
    // Atajos de teclado POS
    // F1: Buscar productos
    // F2: Pagos
    // F5: Confirmar venta
    // =========================
    (function initPosShortcuts(){
      function isAnyModalOpen() {
        return !!document.querySelector(".modal.open");
      }

      function openBuscarShortcut() {
        const btn = document.getElementById("btn_open_buscar");
        if (!btn || btn.disabled) return;
        btn.click();
      }

      function openPagosShortcut() {
        const btn = document.getElementById("btn_open_pagos");
        if (!btn || btn.disabled) return;
        btn.click();
      }

      function confirmarVentaShortcut() {
        const btn = document.getElementById("confirm_venta_btn");
        const form = document.getElementById("confirm_venta_form");
        if (!btn || !form || btn.disabled) return;
        if (typeof form.requestSubmit === "function") form.requestSubmit();
        else form.submit();
      }

      document.addEventListener("keydown", function (e) {
        if (!e || e.repeat) return;
        if (e.ctrlKey || e.altKey || e.metaKey) return;

        const key = (e.key || "").toUpperCase();
        if (key !== "F1" && key !== "F2" && key !== "F5") return;

        // Evita ayuda del navegador (F1) y refresh (F5)
        e.preventDefault();

        // Si hay un modal abierto, evitamos abrir otro o confirmar venta por accidente.
        if (isAnyModalOpen()) return;

        if (key === "F1") {
          openBuscarShortcut();
          return;
        }
        if (key === "F2") {
          openPagosShortcut();
          return;
        }
        if (key === "F5") {
          confirmarVentaShortcut();
        }
      }, true);
    })();

    // =========================
    // HTMX hooks
    // =========================
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      initSelects(evt.target);

      if (evt.target && evt.target.id === "carrito_body") {
        const wrap = document.getElementById("carrito_scroll");
        if (wrap) wrap.scrollTop = 0;

        const scanInput = document.getElementById("scan_reader_input");
        if (scanInput) scanInput.focus();
      }
    });

    // Delegated change handler: submit form when tarjeta select changes
    document.body.addEventListener('change', function(evt){
      try{
        var el = evt.target || evt.srcElement;
        if(!el) return;
        if(el.matches && el.matches('select.tarjeta-select')){
          var f = el.closest('form');
          if(f){
            if(typeof f.requestSubmit === 'function') f.requestSubmit();
            else f.submit();
          }
        }
      }catch(e){/* ignore */}
    }, true);

    document.body.addEventListener('htmx:oobAfterSwap', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:oobAfterSettle', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      initSelects(document);
    });

    document.body.addEventListener("htmx:responseError", function (evt) {
      // Si la respuesta contiene HX-Trigger, HTMX ya disparará el evento posToast;
      // evitamos duplicados.
      try {
        var xhr = evt && evt.detail && evt.detail.xhr;
        var hxTrigger = xhr && typeof xhr.getResponseHeader === 'function' && xhr.getResponseHeader('HX-Trigger');
        if (hxTrigger) return;
      } catch (e) { /* ignore */ }

      // Mostrar el error via posToast en lugar de inyectar en el card de confirmación
      var msg = (evt && evt.detail && evt.detail.xhr && evt.detail.xhr.responseText) ? evt.detail.xhr.responseText : "Error al confirmar.";
      document.body.dispatchEvent(new CustomEvent('posToast', { detail: { message: msg } }));
    });

    function setConfirmVentaLoading(isLoading){
      var btn = document.getElementById("confirm_venta_btn");
      if (!btn) return;
      if (isLoading) {
        btn.dataset.prevText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Procesando...";
      } else {
        btn.disabled = false;
        if (btn.dataset.prevText) btn.textContent = btn.dataset.prevText;
      }
    }

    document.body.addEventListener("htmx:beforeRequest", function (evt) {
      var el = evt && evt.detail ? evt.detail.elt : null;
      if (!el) return;
      if (el.id === "confirm_venta_form" || (el.closest && el.closest("#confirm_venta_form"))) {
        setConfirmVentaLoading(true);
      }
    });

    document.body.addEventListener("htmx:afterRequest", function (evt) {
      var el = evt && evt.detail ? evt.detail.elt : null;
      if (!el) return;
      if (el.id === "confirm_venta_form" || (el.closest && el.closest("#confirm_venta_form"))) {
        setConfirmVentaLoading(false);
      }
    });

    document.body.addEventListener("posToast", function (evt) {
      var msg = (evt && evt.detail && evt.detail.message) ? evt.detail.message : '';

      // Crear contenedor superior si no existe
      var container = document.getElementById('pos_toast_container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'pos_toast_container';
        container.style.position = 'fixed';
        container.style.zIndex = '20000';
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.alignItems = 'flex-end';
        container.style.gap = '12px';
        document.body.appendChild(container);

        // function to position container: below navbar and centered in the gap
        function positionToastContainer() {
          var nav = document.querySelector('nav');
          var topOffset = 12;
          if (nav && nav.getBoundingClientRect) {
            try { topOffset = nav.getBoundingClientRect().bottom + 8; } catch(e){}
          }
          container.style.top = topOffset + 'px';

          // center between right edge of .container and viewport right edge
          var content = document.querySelector('.container');
          var rightEdge = 0;
          if (content && content.getBoundingClientRect) {
            try { rightEdge = content.getBoundingClientRect().right; } catch(e) { rightEdge = 0; }
          }
          var viewportRight = window.innerWidth || document.documentElement.clientWidth;
          var mid = Math.floor((rightEdge + viewportRight) / 2);

          container.style.left = mid + 'px';
          container.style.right = 'auto';
          container.style.transform = 'translateX(-50%)';
        }

        // initial positioning and on resize
        positionToastContainer();
        window.addEventListener('resize', positionToastContainer);
      }

      var toast = document.createElement('div');
      toast.className = 'pos-toast';
      // Fondo rojo semitransparente con texto negro, manteniendo el tamaño y sombras
      toast.style.background = 'rgba(255,82,82,0.92)';
      toast.style.color = '#000';
      toast.style.padding = '15px 20px';
      toast.style.borderRadius = '6px';
      toast.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      toast.style.maxWidth = '605px';
      toast.style.textAlign = 'center';
      toast.style.fontSize = '20px';
      toast.innerHTML = msg;

      container.appendChild(toast);

      // Remover después de 5 segundos
      setTimeout(function(){
        try { container.removeChild(toast); } catch(e){}
        if (container && !container.firstChild) {
          try { container.remove(); } catch(e){}
        }
      }, 5000);
    });
  </script>

</body>
</html>

