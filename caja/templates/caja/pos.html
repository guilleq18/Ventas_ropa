{# templates/caja/pos.html #}
{% load caja_extras %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Caja</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/css/materialize.min.css">
  <script src="https://cdn.jsdelivr.net/npm/materialize-css@1.0.0/dist/js/materialize.min.js"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <style>
    /* =======================
       Modal Venta
    ======================= */
    #venta_modal.modal{
      width: 85% !important;
      max-width: 1100px !important;
    }
    @media (max-width: 600px){
      #venta_modal.modal{ width: 95% !important; }
    }

    /* =======================
       Layout cards POS
    ======================= */
    .pos-card{ display:flex; flex-direction:column; min-height:0; }
    .pos-card .card-content{ display:flex; flex-direction:column; height:100%; min-height:0; }
    .pos-card .card-head{ flex:0 0 auto; }
    .pos-card .card-body{
      flex:1 1 auto;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-top:1px solid rgba(0,0,0,.08);
      margin-top:10px;
      padding-top:10px;
      min-height:0;
    }
    .pos-card .card-body .collection{ margin:0; }

    .card-head.sticky-head{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #fff;
      padding-bottom: 8px;
    }

    .card-head-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-head-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pos-scan-input{
      width: 240px;
      max-width: 100%;
      height: 36px;
      padding: 0 10px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      box-sizing: border-box;
      background: #fff;
    }

    /* Header de carrito: mejor adaptación en anchos intermedios */
    .card-carrito .card-head-actions{
      width: 100%;
      justify-content: flex-start;
    }
    .card-carrito .card-head-actions #btn_open_buscar{
      margin-right: 0 !important;
      flex: 0 0 auto;
    }
    .card-carrito .card-head-actions .pos-scan-input{
      flex: 1 1 240px;
      min-width: 190px;
    }
    .card-carrito .card-head-actions form{
      margin: 0;
      flex: 0 0 auto;
    }
    .card-pagos .card-head-actions{
      width: 100%;
      justify-content: flex-start;
      gap: 8px;
    }
    .card-pagos .card-head-actions form{
      margin: 0;
      flex: 0 0 auto;
    }

    @media (max-width: 992px){
      .card-carrito .card-head-row{
        align-items: flex-start;
      }
      .card-carrito .card-head-actions{
        gap: 8px;
      }
      .card-carrito .card-head-actions .pos-scan-input{
        flex-basis: 100%;
        min-width: 0;
        width: 100%;
      }

      .card-pagos .card-head-row{
        align-items: flex-start;
      }
      .card-pagos .card-head-actions{
        width: 100%;
      }
      .card-pagos .card-head-actions form{
        flex: 1 1 auto;
      }
      .card-pagos .card-head-actions form button{
        width: 100%;
        padding-left: 12px;
        padding-right: 12px;
      }

      .pos-sticky .controls{
        align-items: flex-start;
      }
      .pos-sticky .left{
        width: 100%;
        gap: 8px;
      }
      .pos-sticky .left > *{
        flex: 0 0 auto;
      }
      .pos-sticky .right{
        width: 100%;
        justify-content: flex-start;
      }
      .pos-sticky .right .btn-large{
        width: 100%;
      }
    }

    @media (min-width: 601px){
      /* mantener la misma altura vertical para cada card */
      .card-carrito{ height: calc(100vh - 220px); }
      .card-pagos{ height: calc(100vh - 220px); }
    }

    @media (max-width: 600px){
      .card-carrito, .card-pagos{ height:auto; }
      .card-carrito .card-body{ max-height: 260px; }
      .card-pagos .card-body{ max-height: 340px; }
      .card-carrito .card-head-actions{
        width: 100%;
      }
      .card-carrito .card-head-actions #btn_open_buscar,
      .card-carrito .card-head-actions form{
        width: 100%;
      }
      .card-carrito .card-head-actions form button{
        width: 100%;
      }
      .card-carrito .card-head-actions .pos-scan-input{
        width: 100%;
        flex-basis: 100%;
      }
      .card-pagos .card-head-actions{
        width: 100%;
      }
      .card-pagos .card-head-actions form{
        width: 100%;
      }
      .card-pagos .card-head-actions form button{
        width: 100%;
      }
      .pos-sticky .left{
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      .pos-sticky .left .chip{
        margin: 0;
      }
    }

    /* Selects */
    .select-wrapper input.select-dropdown{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pagos-select .select-wrapper input.select-dropdown{
      padding-right: 2.2rem !important;
      box-sizing:border-box;
    }
    .pagos-select .select-wrapper .caret{ right:.5rem; }

    /* Barra sticky inferior */
    .pos-sticky{
      position: sticky;
      bottom: 0;
      z-index: 999;
      border-top: 1px solid rgba(0,0,0,.08);
    }
    .pos-sticky .card-content{ padding: 12px 16px; }
    .pos-sticky .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin:0;
    }
    .pos-sticky .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pos-sticky .right{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .touch-btn{ height:48px; line-height:48px; }
    .chip.sucursal-chip{ font-weight:600; }
    @media (max-width: 600px){
      .pos-sticky .controls{ gap:10px; }
      .pos-sticky .right{ width:100%; justify-content:stretch; }
      .pos-sticky .right .btn-large{ width:100%; }
    }

    /* =======================
       NAV POS (pro)
    ======================= */
    .pos-nav{
      background: #0f172a;
    }
    .pos-nav .brand-logo{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .pos-nav .nav-badge{
      font-size: 12px;
      opacity: .85;
      margin-left: 10px;
      font-weight: 600;
    }
    .pos-nav .nav-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.15);
      border-radius:999px;
      font-size:12px;
      line-height:1;
      color:#fff;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .pos-nav .nav-chip i{ font-size:18px; }
    .pos-nav .nav-actions a{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pos-nav .btn-flat{
      color:#fff;
    }
    .pos-nav .btn-flat:hover{
      background: rgba(255,255,255,.08);
    }

    .dropdown-content{
      border-radius:10px;
      overflow:hidden;
    }
    .dropdown-content li>a, .dropdown-content li>span{
      font-size:14px;
    }

    .pos-nav .nav-wrapper{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .pos-nav .brand-logo{
      position: static !important;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .pos-nav ul.right{
      position: static !important;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pos-nav i.material-icons{
      text-transform:none !important;
    }

    @media (max-width: 1100px){
      #nav_clock{ display:none; }
    }
    /* =======================
       Buscar modal styles — estética
    ======================= */
    /* Contenedor del modal centrado y con ancho más contenido */
    #buscar_modal.modal{
      max-width: 900px;
      width: 85% !important;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.18);
      overflow: visible !important;
    }

    /* Hacemos que el contenido del modal sea transparente y dejamos la tarjeta como el visual principal */
    #buscar_modal .modal-content{
      overflow: hidden !important;
      padding: 0;
      background: transparent;
      display: flex;
      flex-direction: column;
    }

    /* Card interior: borde suave, esquinas y recorte */
    #buscar_modal .card.pos-card{
      margin: 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: none;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* Encabezado fijo y con padding uniforme */
    #buscar_modal .card-head{
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 6;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    #buscar_modal .card-head .card-title{ margin:0; font-size:18px; }

    /* Input y espacio alrededor */
    #buscar_modal .input-field{ margin: 0; padding: 0 16px 8px 16px; background: #fff; }

    /* Solo el cuerpo de resultados es scrollable */
    #buscar_modal .card-body{
      overflow-y: auto !important;
      max-height: calc(70vh - 120px);
      padding: 8px 16px 16px 16px;
      background: #fff;
    }

    /* Ajustes de items para una lectura más clara */
    #buscar_modal .collection-item{ padding: 10px 12px; }
    #buscar_modal .select-wrapper input.select-dropdown{ padding-left:8px; }

    /* Footer del modal alineado al modal de pagos */
    #buscar_modal .modal-footer{
      background: #fff;
      border-top: 1px solid rgba(0,0,0,.08);
      padding: 10px 24px;
    }
    #buscar_modal_scroll{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
    }
    .pos-shell-card{
      margin: 0;
      padding: 14px 14px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 4px 16px rgba(15,23,42,0.06);
      background: #f8fafc;
    }
    .pos-shell-card > .row{ margin-bottom: 0; }
    .pos-shell-card .pos-sticky{ margin-top: 6px; }
    @media (max-width: 600px){
      .pos-shell-card{ padding: 10px 10px 8px; }
    }
    /* POS container más ancho para aprovechar espacio lateral en pantallas grandes */
    .pos-container{ max-width:1400px; }
  </style>
</head>

<body class="grey lighten-4">

  <!-- NAV -->
  <nav class="pos-nav z-depth-1">
    <div class="nav-wrapper container">
      <a href="{% url 'caja:pos' %}" class="brand-logo">
        Caja <span class="nav-badge">POS</span>
      </a>

      <a href="#" data-target="mobile_nav" class="sidenav-trigger">
        <i class="material-icons">menu</i>
      </a>

      <ul class="right hide-on-med-and-down nav-actions">
        <li>
          <span class="nav-chip">
            <i class="material-icons">store</i>
            {{ sucursal.nombre }}
          </span>
        </li>

        <li>
          <span class="nav-chip" id="nav_clock">
            <i class="material-icons">schedule</i>
            --:--
          </span>
        </li>

        <li>
          <a class="btn-flat waves-effect" href="{% url 'caja:pos' %}">
            <i class="material-icons">add_shopping_cart</i>
            Nueva venta
          </a>
        </li>

        <li>
          <a class="btn-flat waves-effect" href="/admin/" target="_blank">
            <i class="material-icons">settings</i>
            Admin
          </a>
        </li>

        <li>
          <a class="dropdown-trigger btn-flat waves-effect" href="#!" data-target="user_dd">
            <i class="material-icons">account_circle</i>
            {{ request.user.username|default:"Usuario" }}
            <i class="material-icons right">arrow_drop_down</i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <ul id="user_dd" class="dropdown-content">
    <li><a href="/admin/password_change/" target="_blank"><i class="material-icons">lock</i>Cambiar clave</a></li>
    <li class="divider" tabindex="-1"></li>
    <li><a href="/admin/logout/"><i class="material-icons">logout</i>Salir</a></li>
  </ul>

  <ul class="sidenav" id="mobile_nav">
    <li>
      <div class="user-view" style="background:#0f172a;">
        <span class="white-text" style="font-weight:800;">Caja POS</span>
        <span class="white-text" style="opacity:.85;">{{ sucursal.nombre }}</span>
        <span class="white-text" style="opacity:.85;">{{ request.user.username|default:"Usuario" }}</span>
      </div>
    </li>
    <li><a href="{% url 'caja:pos' %}"><i class="material-icons">add_shopping_cart</i>Nueva venta</a></li>
    <li><a href="/admin/" target="_blank"><i class="material-icons">settings</i>Admin</a></li>
    <li><a href="/admin/logout/"><i class="material-icons">logout</i>Salir</a></li>
  </ul>

  <div class="container pos-container" style="margin-top:18px;">
    <div class="card pos-shell-card">
      <div class="row">

      <!-- Columna 1: Carrito -->
      <div class="col s12 m6 l7">
        <div class="card pos-card card-carrito">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Carrito</span>

                <div class="card-head-actions">

                  <button id="btn_open_buscar" type="button" class="btn blue darken-1 waves-effect waves-light" style="margin-right:8px;">
                    <i class="material-icons left">search</i>Buscar
                  </button>

                  <input id="scan_reader_input"
                         type="text"
                         class="browser-default pos-scan-input"
                         autocomplete="off"
                         autocapitalize="off"
                         spellcheck="false"
                         inputmode="none"
                         placeholder="Escanear código (lector)"
                         aria-label="Escaneo rápido por lector de código de barras"
                         title="Solo lecturas por lector (rápidas + Enter)">

                  <form hx-post="{% url 'caja:carrito_vaciar' %}"
                        hx-target="#carrito_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button class="btn red lighten-1 waves-effect waves-light" type="submit">
                      Vaciar
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <div class="card-body" id="carrito_scroll">
              <div id="carrito_body">
                {% include "caja/_carrito.html" with items=cart_items total=cart_total %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Columna 2: Pagos -->
      <div class="col s12 m6 l5">
        <div class="card pos-card card-pagos">
          <div class="card-content">

            <div class="card-head sticky-head">
              <div class="card-head-row">
                <span class="card-title" style="margin:0;">Pagos</span>

                <div class="card-head-actions">
                  {# ✅ POST con CSRF (si lo hacés con button suelto, Django te tira 403) #}
                  <form hx-post="{% url 'caja:pagos_add_modal' %}"
                        hx-target="#pagos_modal_body"
                        hx-swap="innerHTML"
                        style="margin:0;">
                    {% csrf_token %}
                    <button type="button"
                            class="btn green darken-1 waves-effect waves-light"
                            hx-post="{% url 'caja:pagos_modal_open' %}"
                            hx-target="#pago_modal_content"
                            hx-swap="innerHTML">
                      <i class="material-icons left">add</i>AGREGAR
                    </button>

                  </form>

                  <form hx-post="{% url 'caja:pagos_vaciar_table' %}"
                        hx-swap="none"
                        style="margin:0;">
                    {% csrf_token %}
                    <button class="btn red lighten-1 waves-effect waves-light" type="submit">
                      Vaciar
                    </button>
                  </form>
                </div>
              </div>

              <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,.08);">
                <div id="pagos_totales" style="margin-top:0;">
                  {% include "caja/_pagos_totales.html" %}
                </div>
              </div>
            </div>

            <div class="card-body" id="pagos_scroll">
              <div id="pagos_table">
                {% include "caja/_pagos_table.html" with payments=payments %}
              </div>
            </div>

          </div>
        </div>
      </div>

      </div><!-- /row -->

      <!-- Barra sticky inferior (Confirmación) -->
      <div class="card pos-sticky">
        <div class="card-content">
          <form
            hx-post="{% url 'caja:confirmar' %}"
            hx-target="#confirm_res"
            hx-swap="innerHTML"
            hx-target-error="#confirm_res"
          >
            {% csrf_token %}
            <input id="confirm_token_input" type="hidden" name="confirm_token" value="{{ confirm_token }}">

            <div class="controls">
              <div class="left">
                <span class="grey-text text-darken-1">Sucursal</span>
                <div class="chip sucursal-chip">{{ sucursal.nombre }}</div>

                <span class="grey-text text-darken-1">
                  Total a cobrar: $<strong id="total_cobrar_confirm">{{ total_cobrar|num_ar }}</strong>
                </span>
              </div>

              <div class="right">
                <button class="btn-large waves-effect waves-light green touch-btn" type="submit">
                  Confirmar venta
                </button>
              </div>
            </div>
          </form>

          <div id="confirm_res" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Modal Buscar (mejorado) -->
<div id="buscar_modal" class="modal modal-fixed-footer">
  <!-- Header sticky -->
  <div class="modal-content" style="padding-top:0;">
    <div class="white"
         style="position:sticky; top:0; z-index:10; padding:12px 0 10px; border-bottom:1px solid rgba(0,0,0,.08);">
      <div class="row" style="margin:0;">
        <div class="col s12">
          <div class="card-panel" style="margin:0; padding:14px 16px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">
              <div style="min-width:240px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(0,150,136,0.08);">
                    <i class="material-icons teal-text" style="font-size:22px;">search</i>
                  </div>
                  <div>
                    <h4 style="margin:0; font-weight:700; font-size:18px;">Buscador de productos</h4>
                    <div class="grey-text" style="font-size:12px; margin-top:4px;">Encontrá variantes por SKU, nombre o código de barras.</div>
                  </div>
                </div>
              </div>

              <a href="#!" class="modal-close btn-flat" title="Cerrar" style="padding:0 10px;">
                <i class="material-icons">close</i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="white"
         style="position:sticky; top:94px; z-index:9; padding:0 0 10px;">
      <div class="row" style="margin:0;">
        <div class="col s12">
          <div class="card-panel" style="margin:0; padding:12px 16px;">
            <div class="input-field" style="margin:0; background:#fff; border:1px solid rgba(0,0,0,.10); border-radius:10px; padding:4px 12px 0 12px; position:relative;">
              <i class="material-icons prefix teal-text text-darken-1">search</i>

              <!-- ✅ ID único (evita conflicto con el input principal del POS) -->
              <input id="q_modal" name="q" type="text"
                     autocomplete="off"
                     inputmode="search"
                     placeholder="SKU, nombre o código de barras…"
                     hx-get="{% url 'caja:buscar' %}"
                     hx-trigger="keyup changed delay:250ms"
                     hx-target="#buscar_modal_resultados"
                     hx-swap="innerHTML"
                     hx-sync="#buscar_modal:queue"
                     hx-indicator="#buscar_modal_spinner">

              <!-- Botón limpiar -->
              <a href="#!" id="q_modal_clear"
                 class="btn-flat"
                 style="position:absolute; right:8px; top:4px; height:48px; line-height:48px;"
                 title="Limpiar">
                <i class="material-icons grey-text">backspace</i>
              </a>
            </div>

            <!-- Indicador (spinner) -->
            <div id="buscar_modal_spinner" class="progress" style="margin:6px 0 0; display:none;">
              <div class="indeterminate"></div>
            </div>

            <div class="grey-text" style="font-size:12px; margin-top:8px;">
              Tip: podés pegar el código o escanear con lector USB.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Body (scroll) -->
    <div id="buscar_modal_scroll" style="padding-top:12px;">
      <div id="buscar_modal_resultados" style="padding:0 16px 12px;">
        {% include "caja/_resultados.html" with results=None %}
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <a href="#!" class="btn green darken-1 waves-effect waves-light modal-close">
      <i class="material-icons left">check</i>Aplicar
    </a>
  </div>
</div>
  <!--{# =======================
     Modal Pagos
  ======================= #}-->
    <div id="pago_modal" class="modal modal-fixed-footer">
    <div class="modal-content" id="pago_modal_content">
      <!-- HTMX inyecta SOLO el body acá -->
    </div>

    <div class="modal-footer">
      

      <a href="#!" class="btn blue waves-effect waves-light modal-close">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>
  </div>

  <!--{# =======================
     Modal Venta (post-confirm)
  ======================= #}-->
  {% if last_sale %}
    <div id="venta_modal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h5 style="margin-top:0;">Venta #{{ last_sale.id }}</h5>

        <div class="grey-text" style="margin-bottom:12px;">
          {{ last_sale.fecha|date:"d/m/Y H:i" }} — {{ last_sale.sucursal.nombre }}
        </div>

        <h6 style="margin:14px 0 8px;">Items</h6>
        <table class="striped" style="font-size:13px;">
          <thead>
            <tr>
              <th style="width:50%;">Producto</th>
              <th style="width:12%;">Cant.</th>
              <th class="right-align" style="width:19%;">Unit.</th>
              <th class="right-align" style="width:19%;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for it in last_sale.items.all %}
              <tr>
                <td>
                  <div style="font-weight:600; line-height:1.2;">{{ it.variante.sku }}</div>
                  <div class="grey-text" style="font-size:12px; line-height:1.2;">
                    {{ it.variante.producto.nombre }}
                  </div>
                </td>
                <td>{{ it.cantidad }}</td>
                <td class="right-align">${{ it.precio_unitario|num_ar }}</td>
                <td class="right-align"><strong>${{ it.subtotal|num_ar }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top:8px; text-align:right;">
          <span class="grey-text text-darken-2">Total por items:</span>
          <strong>${{ last_sale_total_items|num_ar }}</strong>
        </div>

        <h6 style="margin:16px 0 8px;">Formas de pago</h6>
        <ul class="collection" style="margin:0;">
          {% for p in last_sale_pagos %}
            <li class="collection-item" style="display:flex; justify-content:space-between; gap:12px;">
              <div>
                <div style="font-weight:600;">{{ p.get_tipo_display }}</div>

                {% if p.tipo == "CREDITO" %}
                  <div class="grey-text" style="font-size:12px;">
                    {% if p.plan %}{{ p.plan.tarjeta }} — {% endif %}
                    {{ p.cuotas }} cuotas
                    {% if p.recargo_pct|add:0 > 0 %} — Recargo {{ p.recargo_pct|num_ar }}%{% endif %}
                  </div>
                {% endif %}

                

                {% if p.tipo == "CUENTA_CORRIENTE" and p.referencia %}
                  <div class="grey-text" style="font-size:10px;">
                    {{ p.referencia|cut:"Cuenta corriente — "|cut:"Cuenta corriente - " }}
                  </div>
                {% elif p.referencia %}
                  <div class="grey-text" style="font-size:10px;">Ref: {{ p.referencia }}</div>
                {% endif %}

              <div style="text-align:right; white-space:nowrap;">
                <strong>${{ p.monto|num_ar }}</strong>
                {% if p.tipo == "CREDITO" and p.recargo_calc|add:0 > 0 %}
                  <div class="grey-text" style="font-size:12px;">Recargo: +${{ p.recargo_calc|num_ar }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>

        <div style="margin-top:14px; text-align:right;">
          <span class="grey-text text-darken-2">Total venta:</span>
          <strong style="font-size:18px;">
            {{ last_sale_total_final|num_ar }}
          </strong>
        </div>

      </div>

      <div class="modal-footer">
      

      <a href="#!" class="modal-close btn-flat">Cerrar</a>
      <a href="{% url 'caja:ticket' last_sale.id %}?print=1"
        target="_blank" rel="noopener"
        class="btn blue waves-effect waves-light"
        onclick="closeVentaModalAndFocus();">
        <i class="material-icons left">check</i>Aplicar
      </a>
    </div>

    </div>
  {% endif %}

  <script>
    // =========================
    // Utils
    // =========================
    function initSelects(root){
      if (!window.M || !M.FormSelect) return;
      var elems = (root || document).querySelectorAll('select');
      M.FormSelect.init(elems);
    }

    function initNav(){
      if (!window.M) return;

      const dd = document.querySelectorAll('.dropdown-trigger');
      M.Dropdown.init(dd, { coverTrigger:false, constrainWidth:false });

      const sidenavs = document.querySelectorAll('.sidenav');
      M.Sidenav.init(sidenavs);

      const el = document.getElementById("nav_clock");
      function tick(){
        if(!el) return;
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        el.innerHTML = '<i class="material-icons">schedule</i> ' + hh + ':' + mm;
      }
      tick();
      setInterval(tick, 10000);
    }

    function centerVentaModal(){
      const modalEl = document.getElementById("venta_modal");
      if (!modalEl) return;

      modalEl.style.position = "fixed";

      const w = modalEl.offsetWidth || 0;
      const left = Math.max((window.innerWidth - w) / 2, 12);

      modalEl.style.left = left + "px";
      modalEl.style.right = "auto";
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    // =========================
    // DOM Ready
    // =========================
    document.addEventListener('DOMContentLoaded', function() {
      initSelects(document);
      initNav();

      // Modal pagos
      const pagoModalEl = document.getElementById('pago_modal');
      if (pagoModalEl && window.M && M.Modal) {
        M.Modal.init(pagoModalEl, { dismissible:true });
      }

      // Modal Buscar: init + focus + limpiar + botón abrir
      const buscarModalEl = document.getElementById('buscar_modal');
      if (buscarModalEl && window.M && M.Modal) {
        M.Modal.init(buscarModalEl, {
          dismissible: true,
          onOpenStart: () => {
            setTimeout(() => {
              const q = document.getElementById('q_modal');
              if (q) q.focus();
            }, 50);
          }
        });
      }

      const openBuscarBtn = document.getElementById('btn_open_buscar');
      if (openBuscarBtn) {
        openBuscarBtn.addEventListener('click', function () {
          if (!buscarModalEl || !window.M || !M.Modal) return;
          const inst = M.Modal.getInstance(buscarModalEl) || M.Modal.init(buscarModalEl, { dismissible:true });
          inst.open();
        });
      }

      const clearBtn = document.getElementById('q_modal_clear');
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const q = document.getElementById('q_modal');
          if (!q) return;
          q.value = '';
          q.focus();
          // opcional: limpiar resultados al limpiar input (si querés)
          // document.getElementById('buscar_modal_resultados').innerHTML = '';
        });
      }

    // Si HTMX reinyecta el contenido del modal en algún momento, re-enfocá
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'buscar_modal_resultados') {
        const wrap = document.getElementById('buscar_modal_scroll');
        if (wrap) wrap.scrollTop = 0;
      }
    });

      // Modal venta
      const ventaModalEl = document.getElementById('venta_modal');
      if (ventaModalEl && window.M && M.Modal) {
        const inst = M.Modal.init(ventaModalEl, {
          dismissible: true,
          onOpenEnd: centerVentaModal
        });

        inst.open();
        setTimeout(centerVentaModal, 0);
        setTimeout(centerVentaModal, 50);
        window.addEventListener("resize", centerVentaModal);
      }

      // Barra rápida de lector (solo acepta ráfagas de teclas típicas de escáner + Enter)
      const scanReaderInput = document.getElementById("scan_reader_input");
      if (scanReaderInput) {
        let scanBurst = { startedAt: 0, lastAt: 0, keyCount: 0 };

        function resetScanBurst() {
          scanBurst = { startedAt: 0, lastAt: 0, keyCount: 0 };
        }

        scanReaderInput.addEventListener("paste", function (e) {
          e.preventDefault();
        });

        scanReaderInput.addEventListener("keydown", function (e) {
          const now = (window.performance && performance.now) ? performance.now() : Date.now();

          if (e.key === "Enter") {
            e.preventDefault();
            const q = scanReaderInput.value.trim();
            if (!q) {
              resetScanBurst();
              return;
            }

            const duration = (scanBurst.startedAt && scanBurst.lastAt) ? (scanBurst.lastAt - scanBurst.startedAt) : 9999;
            const looksLikeScanner = scanBurst.keyCount >= 6 && duration <= 350;

            if (!looksLikeScanner) {
              scanReaderInput.value = "";
              resetScanBurst();
              return;
            }

            htmx.ajax("POST", "{% url 'caja:scan_add' %}", {
              target: "#carrito_body",
              swap: "innerHTML",
              values: { q },
              headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            scanReaderInput.value = "";
            resetScanBurst();
            return;
          }

          if (e.key === "Tab") {
            resetScanBurst();
            return;
          }

          if (e.ctrlKey || e.altKey || e.metaKey) return;

          if (e.key.length === 1) {
            if (!scanBurst.lastAt || (now - scanBurst.lastAt) > 120) {
              scanBurst.startedAt = now;
              scanBurst.keyCount = 0;
            }
            scanBurst.lastAt = now;
            scanBurst.keyCount += 1;
          }
        });

        scanReaderInput.addEventListener("blur", resetScanBurst);
      }
    });

    // Abrir/cerrar modal pagos vía triggers
    document.body.addEventListener("openPagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      const inst = M.Modal.getInstance(el) || M.Modal.init(el, { dismissible:true });
      inst.open();
    });

    document.body.addEventListener("closePagoModal", function(){
      const el = document.getElementById("pago_modal");
      if (!el || !window.M || !M.Modal) return;
      const inst = M.Modal.getInstance(el);
      if (inst) inst.close();
    });

    // =========================
    // HTMX hooks
    // =========================
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      initSelects(evt.target);

      if (evt.target && evt.target.id === "carrito_body") {
        const wrap = document.getElementById("carrito_scroll");
        if (wrap) wrap.scrollTop = 0;

        const scanInput = document.getElementById("scan_reader_input");
        if (scanInput) scanInput.focus();
      }
    });

    // Delegated change handler: submit form when tarjeta select changes
    document.body.addEventListener('change', function(evt){
      try{
        var el = evt.target || evt.srcElement;
        if(!el) return;
        if(el.matches && el.matches('select.tarjeta-select')){
          var f = el.closest('form');
          if(f){
            if(typeof f.requestSubmit === 'function') f.requestSubmit();
            else f.submit();
          }
        }
      }catch(e){/* ignore */}
    }, true);

    document.body.addEventListener('htmx:oobAfterSwap', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:oobAfterSettle', function () {
      initSelects(document);
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      initSelects(document);
    });

    document.body.addEventListener("htmx:responseError", function (evt) {
      // Si la respuesta contiene HX-Trigger, HTMX ya disparará el evento posToast;
      // evitamos duplicados.
      try {
        var xhr = evt && evt.detail && evt.detail.xhr;
        var hxTrigger = xhr && typeof xhr.getResponseHeader === 'function' && xhr.getResponseHeader('HX-Trigger');
        if (hxTrigger) return;
      } catch (e) { /* ignore */ }

      // Mostrar el error via posToast en lugar de inyectar en el card de confirmación
      var msg = (evt && evt.detail && evt.detail.xhr && evt.detail.xhr.responseText) ? evt.detail.xhr.responseText : "Error al confirmar.";
      document.body.dispatchEvent(new CustomEvent('posToast', { detail: { message: msg } }));
    });

    document.body.addEventListener("posToast", function (evt) {
      var msg = (evt && evt.detail && evt.detail.message) ? evt.detail.message : '';

      // Crear contenedor superior si no existe
      var container = document.getElementById('pos_toast_container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'pos_toast_container';
        container.style.position = 'fixed';
        container.style.zIndex = '20000';
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.alignItems = 'flex-end';
        container.style.gap = '12px';
        document.body.appendChild(container);

        // function to position container: below navbar and centered in the gap
        function positionToastContainer() {
          var nav = document.querySelector('nav');
          var topOffset = 12;
          if (nav && nav.getBoundingClientRect) {
            try { topOffset = nav.getBoundingClientRect().bottom + 8; } catch(e){}
          }
          container.style.top = topOffset + 'px';

          // center between right edge of .container and viewport right edge
          var content = document.querySelector('.container');
          var rightEdge = 0;
          if (content && content.getBoundingClientRect) {
            try { rightEdge = content.getBoundingClientRect().right; } catch(e) { rightEdge = 0; }
          }
          var viewportRight = window.innerWidth || document.documentElement.clientWidth;
          var mid = Math.floor((rightEdge + viewportRight) / 2);

          container.style.left = mid + 'px';
          container.style.right = 'auto';
          container.style.transform = 'translateX(-50%)';
        }

        // initial positioning and on resize
        positionToastContainer();
        window.addEventListener('resize', positionToastContainer);
      }

      var toast = document.createElement('div');
      toast.className = 'pos-toast';
      // Fondo rojo semitransparente con texto negro, manteniendo el tamaño y sombras
      toast.style.background = 'rgba(255,82,82,0.92)';
      toast.style.color = '#000';
      toast.style.padding = '15px 20px';
      toast.style.borderRadius = '6px';
      toast.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      toast.style.maxWidth = '605px';
      toast.style.textAlign = 'center';
      toast.style.fontSize = '20px';
      toast.innerHTML = msg;

      container.appendChild(toast);

      // Remover después de 5 segundos
      setTimeout(function(){
        try { container.removeChild(toast); } catch(e){}
        if (container && !container.firstChild) {
          try { container.remove(); } catch(e){}
        }
      }, 5000);
    });
  </script>

</body>
</html>
