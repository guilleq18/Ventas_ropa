{# caja/_resultados.html #}
{% load caja_extras %}


{% if not results %}
  <div class="grey-text" style="padding:6px 2px;">Escribí para buscar…</div>
{% else %}
  <ul class="collection">
    {% for v in results %}
      <li class="collection-item">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <div style="font-weight:600;">{{ v.sku }} — {{ v.producto.nombre }}</div>
            <div style="margin-top:6px;">
              <span class="grey-text" style="margin-left:8px;">{{ sucursal.nombre }}</span>
              {% with stock=stock_map|get_item:v.id %}
                {% if not permitir_sin_stock %}
                  {% if stock|default:0|add:0 <= 0 %}
                    <span style="margin-left:8px;">
                      <span class="chip red lighten-4 red-text text-darken-4" style="height:20px; line-height:20px; font-size:12px;">Sin stock</span>
                    </span>
                  {% else %}
                    <span style="margin-left:8px;">
                      <span class="chip green lighten-5 green-text text-darken-2" style="height:20px; line-height:20px; font-size:12px;">Stock: {{ stock }}</span>
                    </span>
                  {% endif %}
                {% endif %}
              {% endwith %}
            </div>
          </div>

          <div style="text-align:right; min-width:120px;">
            <div style="font-weight:700;">${{ v.precio|num_ar }}</div>

            <form hx-post="{% url 'caja:carrito_agregar' v.id %}"
                  hx-target="#carrito_body"
                  hx-swap="innerHTML"
                  style="margin-top:8px;">
              {% csrf_token %}
              {% with stock=stock_map|get_item:v.id %}
                {% if permitir_sin_stock %}
                  <button type="submit" class="btn-small blue" aria-disabled="false" title="Agregar">Agregar</button>
                {% else %}
                  <button type="submit"
                          class="btn-small {% if stock|default:0|add:0 > 0 %}blue{% else %}grey{% endif %}"
                          {% if stock|default:0|add:0 <= 0 %}disabled aria-disabled="true" title="Sin stock"{% else %}aria-disabled="false" title="Agregar"{% endif %}>
                    Agregar
                  </button>
                {% endif %}
              {% endwith %}
            </form>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>
{% endif %}
