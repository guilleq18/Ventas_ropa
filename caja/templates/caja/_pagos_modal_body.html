{# templates/caja/_pagos_modal_body.html #}
{% load caja_extras %}

<!--{# =========================================================
   MODAL BODY (HTMX)
   IMPORTANTE: siempre swap sobre #pago_modal_content
   ========================================================= #}

{# ===== Header sticky (título + totales fijos) ===== #}-->
<div class="white"
     style="position:sticky; top:0; z-index:10; padding:12px 0 10px; border-bottom:1px solid rgba(0,0,0,.08);">
  <div class="row" style="margin:0;">
    <div class="col s12">
      <div class="card-panel" style="margin:0; padding:14px 16px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">

          <div style="min-width:240px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <div style="width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(0,150,136,0.08);">
                <i class="material-icons teal-text" style="font-size:22px;">account_balance_wallet</i>
              </div>
              <div>
                <h4 style="margin:0; font-weight:700; font-size:18px;">Formas de pago</h4>
                <div class="grey-text" style="font-size:12px; margin-top:4px;">Configurá los pagos. Al cerrar se aplican al detalle.</div>
              </div>
            </div>
          </div>

          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:10px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <span class="chip grey lighten-4" style="font-weight:600;">
                Items: ${{ total_base|num_ar }}
              </span>

              <span class="chip amber lighten-5" style="font-weight:600;">
                <i class="material-icons" style="font-size:16px; line-height:24px; vertical-align:middle;">percent</i>
                Recargos: ${{ recargos|num_ar }}
              </span>

              <span class="chip teal lighten-5" style="font-weight:800;">
                A cobrar: ${{ total_cobrar|num_ar }}
              </span>

              <span class="chip blue lighten-5" style="font-weight:700;">
                Pagado: ${{ pagado|num_ar }}
              </span>

              <span class="chip red lighten-5" style="font-weight:800;">
                Saldo: ${{ saldo|num_ar }}
              </span>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!--{# ===== Footer sticky (abajo del modal) - botón Agregar pago ===== #}-->
<div class="white"
     style="position:sticky; bottom:0; z-index:10; padding:12px 0 10px; border-top:1px solid rgba(0,0,0,.08);">
  <div class="row" style="margin:0;">
    <div class="col s12">
      <div class="card-panel" style="margin:0; padding:12px 16px;">
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
          <div class="grey-text" style="font-size:12px;">
            Los cambios se guardan automáticamente.
          </div>

          <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
            {% if total_base|add:0 > 0 %}
              <form hx-post="{% url 'caja:pagos_add_modal' %}"
                    hx-target="#pago_modal_content"
                    hx-swap="innerHTML"
                    hx-sync="#pago_modal_content:queue"
                    style="margin:0;">
                {% csrf_token %}
                <button type="submit"
                        class="btn green darken-1 waves-effect waves-light"
                        style="height:40px; line-height:40px; border-radius:8px; font-weight:700; display:inline-flex; align-items:center; gap:8px; padding:0 14px; box-shadow:0 2px 6px rgba(0,0,0,0.12);">
                  <i class="material-icons" aria-hidden="true" style="font-size:18px; line-height:1;">add</i>
                  AGREGAR
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# ===== Body ===== #}
<div id="pagos_modal_body" style="padding-top:12px; padding-bottom:8px;">
  {% if total_base <= 0 %}
    <div class="card-panel grey lighten-4" style="padding:12px 14px;">
      <span class="grey-text text-darken-2" style="display:flex; gap:10px; align-items:center;">
        <i class="material-icons">info</i>
        Agregá productos al carrito.
      </span>
    </div>
  {% else %}

    {% if not payments %}
      <div class="card-panel grey lighten-4" style="padding:12px 14px;">
        <span class="grey-text text-darken-2" style="display:flex; gap:10px; align-items:center;">
          <i class="material-icons">hourglass_empty</i>
          No hay pagos cargados.
        </span>
      </div>
    {% endif %}

    {% for p in payments %}
      <div class="card-panel" style="padding:14px; margin-bottom:12px; margin-left:14px; margin-right:14px;">
        <div class="row" style="margin-bottom:0;">

          <!--{# ===========================================================
             FORM principal del pago (NO usar "change" global)
             =========================================================== #}-->
          <form class="col s12 m10 pagos-select"
            id="pago_form_{{ forloop.counter0 }}"
            hx-post="{% url 'caja:pagos_set_modal' forloop.counter0 %}"
            hx-target="#pago_modal_content"
            hx-swap="innerHTML"
            hx-trigger="
              change from:select,
              change from:input[name='monto'],
              blur from:input[name='monto'],
              change from:input[name='referencia'],
              blur from:input[name='referencia']
            "
            style="margin:0;">

            {% csrf_token %}

            <div class="row" style="margin-bottom:0;">
              <div class="input-field col s12 m4" style="margin-top:0;">
                <select name="tipo" {% if p.tipo_locked %}disabled{% endif %}>
                  <option value="CONTADO" {% if p.tipo == "CONTADO" %}selected{% endif %}>Contado</option>
                  <option value="DEBITO" {% if p.tipo == "DEBITO" %}selected{% endif %}>Débito</option>
                  <option value="CREDITO" {% if p.tipo == "CREDITO" %}selected{% endif %}>Crédito</option>
                  <option value="TRANSFERENCIA" {% if p.tipo == "TRANSFERENCIA" %}selected{% endif %}>Transferencia</option>
                  <option value="QR" {% if p.tipo == "QR" %}selected{% endif %}>QR</option>
                  <option value="CUENTA_CORRIENTE" {% if p.tipo == "CUENTA_CORRIENTE" %}selected{% endif %}>
                    Cuenta corriente{% if p.tipo == "CUENTA_CORRIENTE" and p.cc_label %} — {{ p.cc_label }}{% endif %}
                  </option>
                </select>
                <label>Tipo</label>
                {% if p.tipo_locked %}
                  <small class="grey-text">Tipo bloqueado (quitá el pago para cambiarlo)</small>
                {% endif %}
              </div>

              <div class="input-field col s12 m4" style="margin-top:0;">
                <i class="material-icons prefix grey-text">attach_money</i>
                <input type="text"
                       name="monto"
                       inputmode="decimal"
                       placeholder="0,00"
                       value="{{ p.monto|num_ar }}"
                       style="font-weight:600;">
                <label class="active">Monto</label>
                <small class="grey-text">Ej: 12.345,67</small>
              </div>

              <div class="col s12 m4" style="padding-top:8px; text-align:right;">
                {% if p.tipo == "CREDITO" %}
                  <span class="chip amber lighten-5" style="margin-right:6px; font-weight:700;">
                    Recargo: ${{ p.recargo_monto_calc|num_ar }}
                  </span>
                  <span class="chip teal lighten-5" style="font-weight:900;">
                    Total: ${{ p.total_tarjeta_calc|num_ar }}
                  </span>
                {% else %}
                  <span class="chip grey lighten-4" style="font-weight:700;">
                    Sin recargo
                  </span>
                {% endif %}
              </div>
            </div>

            <!--{# ==========================
               Cuenta corriente (BUSCAR CLIENTE)
               ========================== #}-->
            {% if p.tipo == "CUENTA_CORRIENTE" %}
              <div class="row" style="margin:0;">

                <div class="input-field col s12 m6" style="margin-top:0;">
                  <i class="material-icons prefix grey-text">person_search</i>

                  {# Solo búsqueda (GET). NO hx-post acá. #}
                  <input type="text"
                         name="q"
                         autocomplete="off"
                         inputmode="numeric"
                         placeholder="DNI (solo números)"
                         value="{{ p.cc_q|default:'' }}"
                         onkeydown="if(event.key==='Enter'){event.preventDefault();}"

                         hx-get="{% url 'caja:cc_buscar_clientes' forloop.counter0 %}"
                         hx-trigger="keyup changed delay:300ms"
                         hx-target="#cc_results_{{ forloop.counter0 }}"
                         hx-swap="innerHTML">
                  <label class="active">Buscar cliente</label>
                  <small class="grey-text">Se busca mientras escribís (no hace falta salir del campo).</small>
                </div>

                <div class="col s12 m6" style="padding-top:10px;">
                  {% if p.cc_cliente_nombre %}
                    <span class="chip" style="font-weight:700;">
                      {{ p.cc_cliente_nombre }} ({{ p.cc_cliente_dni }})
                    </span>

                    {% if p.cc_ok %}
                      <div class="grey-text" style="font-size:12px; margin-top:6px;">
                        Saldo actual: <strong>${{ p.cc_saldo|num_ar }}</strong>
                      </div>
                    {% else %}
                      <div class="red-text" style="font-size:12px; margin-top:6px;">
                        El cliente no tiene cuenta corriente activa.
                      </div>
                    {% endif %}

                    {# NO anidar forms: botón HTMX que limpia selección #}
                    <button type="button"
                            class="btn-flat"
                            title="Quitar cliente"
                            aria-label="Quitar cliente"
                            style="margin-top:6px;"
                            hx-post="{% url 'caja:pagos_set_modal' forloop.counter0 %}"
                            hx-target="#pago_modal_content"
                            hx-swap="innerHTML"
                            hx-sync="#pago_modal_content:queue"
                            hx-include="#pago_form_{{ forloop.counter0 }} input[name='csrfmiddlewaretoken'], #pago_form_{{ forloop.counter0 }} input[name='monto'], #pago_form_{{ forloop.counter0 }} input[name='referencia']"
                            hx-vals='{"tipo":"CUENTA_CORRIENTE","cc_cliente_id":"","cc_q":""}'>
                      <i class="material-icons">delete</i>
                    </button>
                  {% else %}
                    <div class="grey-text" style="font-size:12px;">
                      Elegí un cliente para debitar la venta a cuenta corriente.
                    </div>
                  {% endif %}
                </div>

              </div>

              {# Resultados de búsqueda #}
              <div id="cc_results_{{ forloop.counter0 }}"></div>
            {% endif %}

           <!-- {# ==========================
               Crédito
               ========================== #}-->
            {% if p.tipo == "CREDITO" %}
              <div class="row" style="margin:0;">
                <div class="input-field col s12 m4" style="margin-top:0;">
                  <i class="material-icons prefix grey-text">credit_card</i>
                  <select name="tarjeta">
                    <option value="" disabled {% if not p.tarjeta %}selected{% endif %}>Elegí tarjeta</option>
                    {% for t in tarjetas %}
                      <option value="{{ t }}" {% if p.tarjeta == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                  </select>
                  <label>Tarjeta</label>
                </div>

                <div class="col s12 m8" id="cuotas_wrap_{{ forloop.counter0 }}" style="padding-top:6px;">
                  {% if p.tarjeta %}
                    <div
                      hx-get="{% url 'caja:pagos_cuotas' forloop.counter0 %}?tarjeta={{ p.tarjeta|urlencode }}"
                      hx-trigger="load"
                      hx-target="#cuotas_wrap_{{ forloop.counter0 }}"
                      hx-swap="innerHTML">
                    </div>
                  {% else %}
                    <div class="card-panel grey lighten-4" style="padding:10px 12px; margin:0;">
                      <span class="grey-text text-darken-2" style="display:flex; gap:8px; align-items:center;">
                        <i class="material-icons">info</i>
                        Elegí tarjeta para ver cuotas
                      </span>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

           <!-- {# ==========================
               Transferencia / QR
               ========================== #}-->
            {% if p.tipo == "TRANSFERENCIA" or p.tipo == "QR" %}
              <div class="row" style="margin:0;">
                <div class="input-field col s12" style="margin-top:0;">
                  <i class="material-icons prefix grey-text">receipt</i>
                  <input type="text" name="referencia" value="{{ p.referencia|default:'' }}">
                  <label class="active">Referencia / Operación</label>
                </div>
              </div>
            {% endif %}

          </form>

          {# ===== Quitar pago (form separado, NO anidado) ===== #}
          <div class="col s12 m2" style="display:flex; justify-content:flex-end; align-items:flex-start;">
            <form hx-post="{% url 'caja:pagos_del_modal' forloop.counter0 %}"
                  hx-target="#pago_modal_content"
                  hx-swap="innerHTML"
                  hx-sync="#pago_modal_content:queue"
                  style="margin:0;">
              {% csrf_token %}
              <button class="btn red waves-effect waves-light" type="submit">
                <i class="material-icons left">delete</i>
              </button>
            </form>
          </div>

        </div>
      </div>
    {% endfor %}

  {% endif %}
</div>
