{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard | Sistema de Ventas</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'branding/vgc-favicon.svg' %}">
  <link rel="shortcut icon" href="{% static 'branding/vgc-favicon.svg' %}">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --ui-bg: #f4e7e0;
      --ui-shell: #efd8cd;
      --ui-card: #f7eee8;
      --ui-card-soft: #f2e0d4;
      --ui-border: rgba(156, 103, 76, 0.18);
      --ui-nav: #7b4f43;
      --ui-nav-2: #6f463b;
      --ui-text-soft: #7a6258;
    }
    body { background:var(--ui-bg); color:#3f2f29; }
    nav .brand-logo { font-size:1.2rem; font-weight:600; }
    .page-title { margin:18px 0 4px 0; font-weight:600; }
    .muted { color:var(--ui-text-soft); }
    .card { border-radius:14px; background:var(--ui-card); border:1px solid var(--ui-border); }
    .kpi-title { font-size:.95rem; color:#546e7a; }
    .kpi-value { margin:6px 0 0 0; font-weight:700; }
    .kpi-title { color:var(--ui-text-soft); }
    .chip-soft { background:#f2e0d4; color:#7b4f43; font-weight:600; }
    .btn-round { border-radius:10px; width:100%; }
    .table-wrap { overflow:auto; }
    .card-panel{ border-radius:12px !important; border:1px solid var(--ui-border); box-shadow:none; }
    .collection{ border-color: var(--ui-border); }
    .collection .collection-item{ background:rgba(255,255,255,.3); border-bottom-color:rgba(156,103,76,.12); }
    .app-nav .nav-wrapper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .app-nav .brand-logo{
      position: static !important;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      line-height:1 !important;
      height:auto !important;
      padding:8px 0;
    }
    .app-nav .brand-logo .brand-mark{
      width:46px;
      height:46px;
      object-fit:contain;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      padding:1px;
      box-shadow: 0 4px 10px rgba(40,20,8,.18);
      flex:0 0 auto;
    }
    .app-nav .brand-logo .brand-copy{
      display:flex;
      flex-direction:column;
      justify-content:center;
      line-height:1;
      gap:2px;
      color:#fff7f2;
    }
    .app-nav .brand-logo .brand-name{
      font-size:1.08rem;
      font-weight:800;
      letter-spacing:.25px;
    }
    .app-nav .brand-logo .brand-caption{
      font-size:.72rem;
      opacity:.88;
      font-weight:600;
      letter-spacing:.2px;
    }
    .app-nav .nav-actions{
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
      flex-wrap:nowrap;
      justify-content:flex-end;
      flex:0 0 auto;
      min-width:0;
    }
    .app-nav .nav-actions li{ list-style:none; }
    .app-nav .nav-actions .btn-flat,
    .app-nav .nav-actions .nav-chip{
      white-space:nowrap;
      flex-shrink:0;
    }
    .app-nav .nav-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.15);
      border-radius:999px;
      font-size:12px;
      line-height:1;
      color:#fff7f2;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .app-nav .nav-chip i{ font-size:18px; }
    .app-nav .btn-flat{
      color:#fff7f2;
      display:flex;
      align-items:center;
      gap:6px;
      border-radius:10px;
    }
    .app-nav .btn-flat:hover{ background: rgba(255,255,255,.08); }
    @media only screen and (max-width: 1200px){
      #core_nav_date{ display:none; }
    }
    @media only screen and (max-width: 992px){
      #core_nav_time{ display:none; }
      .app-nav .nav-actions{ gap:4px; overflow-x:auto; scrollbar-width:none; }
      .app-nav .nav-actions::-webkit-scrollbar{ display:none; }
      .app-nav .btn-flat{ padding:0 8px; }
      .app-nav .brand-logo .brand-caption{ display:none; }
    }
  </style>
</head>

<body>

  <nav class="app-nav" style="background:linear-gradient(180deg, var(--ui-nav) 0%, var(--ui-nav-2) 100%);">
    <div class="nav-wrapper container">
      <a class="brand-logo" href="{% url 'core:dashboard' %}">
        <img class="brand-mark" src="{% static 'branding/vgc-favicon.svg' %}" alt="VGC">
        <span class="brand-copy">
          <span class="brand-name">VGC</span>
          <span class="brand-caption">Sistema de Ventas</span>
        </span>
      </a>
      <ul class="nav-actions">
        <li><a class="btn-flat waves-effect" href="{% url 'core:dashboard' %}"><i class="material-icons">dashboard</i>Dashboard</a></li>
        <li><a class="btn-flat waves-effect" href="{% url 'caja:pos' %}"><i class="material-icons">point_of_sale</i>Caja</a></li>
        <li><a class="btn-flat waves-effect" href="{% url 'admin_panel:dashboard' %}"><i class="material-icons">admin_panel_settings</i>Admin Panel</a></li>
        <li><span class="nav-chip" id="core_nav_date"><i class="material-icons">calendar_today</i>--/--/----</span></li>
        <li><span class="nav-chip" id="core_nav_time"><i class="material-icons">schedule</i>--:--</span></li>
        <li>
          <a class="dropdown-trigger btn-flat waves-effect" href="#!" data-target="core_user_dd">
            <i class="material-icons">account_circle</i>{{ request.user.username }}
            <i class="material-icons right">arrow_drop_down</i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <ul id="core_user_dd" class="dropdown-content">
    <li><a href="{% url 'password_change' %}"><i class="material-icons">lock</i>Cambiar clave</a></li>
    <li class="divider" tabindex="-1"></li>
    <li>
      <a href="{% url 'logout' %}" onclick="event.preventDefault(); document.getElementById('core_logout_form').submit();">
        <i class="material-icons">logout</i>Salir
      </a>
    </li>
  </ul>

  <form id="core_logout_form" method="post" action="{% url 'logout' %}" style="display:none;">
    {% csrf_token %}
  </form>

  <main class="container">

    <div class="row" style="margin-top:10px;">
      <div class="col s12">
        <div class="chip chip-soft">Hoy: {{ hoy|date:"d/m/Y" }}</div>
        <h5 class="page-title">Panel principal</h5>
        <div class="muted">Resumen del día, accesos rápidos y alertas operativas.</div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row">
      <div class="col s12 m6 l3">
        <div class="card white z-depth-1">
          <div class="card-content">
            <div class="kpi-title">Ventas hoy</div>
            <h5 class="kpi-value">{{ kpis.ventas_hoy }}</h5>
            <div class="muted">Operaciones registradas</div>
          </div>
        </div>
      </div>

      <div class="col s12 m6 l3">
        <div class="card white z-depth-1">
          <div class="card-content">
            <div class="kpi-title">Ingresos hoy</div>
            <h5 class="kpi-value">$ {{ kpis.ingresos_hoy }}</h5>
            <div class="muted">Total facturado</div>
          </div>
        </div>
      </div>

      <div class="col s12 m6 l3">
        <div class="card white z-depth-1">
          <div class="card-content">
            <div class="kpi-title">Ticket promedio</div>
            <h5 class="kpi-value">$ {{ kpis.ticket_promedio }}</h5>
            <div class="muted">Promedio por venta</div>
          </div>
        </div>
      </div>

      <div class="col s12 m6 l3">
        <div class="card white z-depth-1">
          <div class="card-content">
            <div class="kpi-title">Stock bajo</div>
            <h5 class="kpi-value">{{ kpis.stock_bajo }}</h5>
            <div class="muted">Productos a reponer</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accesos rápidos + Caja -->
    <div class="row">
      <div class="col s12 l7">
        <div class="card white z-depth-1">
          <div class="card-content">
            <span class="card-title" style="font-size:1.1rem; font-weight:700;">Accesos rápidos</span>

            <div class="row" style="margin-bottom:0;">
              <div class="col s12 m6">
                <a class="btn blue darken-2 waves-effect btn-round" href="/ventas/">
                  Ventas / POS
                </a>
                <div class="muted" style="margin:8px 0 14px 0;">Registrar ventas rápido.</div>
              </div>

              <div class="col s12 m6">
                <a class="btn teal darken-2 waves-effect btn-round" href="/catalogo/">
                  Productos / Catálogo
                </a>
                <div class="muted" style="margin:8px 0 14px 0;">Altas, edición y stock.</div>
              </div>

              <div class="col s12 m6">
                <a class="btn brown darken-2 waves-effect btn-round" href="/caja/">
                  Caja
                </a>
                <div class="muted" style="margin:8px 0 14px 0;">Ingresos/egresos y cierres.</div>
              </div>

              <div class="col s12 m6">
                <a class="btn grey darken-2 waves-effect btn-round" href="{% url 'admin_panel:dashboard' %}">
                  Admin Panel
                </a>
                <div class="muted" style="margin:8px 0 14px 0;">Configuración, reportes y gestión interna.</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col s12 l5">
        <div class="card white z-depth-1">
          <div class="card-content">
            <span class="card-title" style="font-size:1.1rem; font-weight:700;">Estado de caja</span>

            <div class="card-panel" style="background:#f2e0d4; color:#6f463b;">
              <div style="font-weight:700; font-size:1.1rem;">Saldo actual: $ {{ caja.saldo_actual }}</div>
              <div class="muted">Resumen del día</div>
            </div>

            <ul class="collection" style="border-radius:12px; overflow:hidden;">
              <li class="collection-item">
                <b>Ingresos hoy:</b> $ {{ caja.ingresos_hoy }}
              </li>
              <li class="collection-item">
                <b>Egresos hoy:</b> $ {{ caja.egresos_hoy }}
              </li>
            </ul>

            <div class="muted">Próximo paso: agregar botón de “Cierre de caja”.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Últimas ventas + Alertas -->
    <div class="row">
      <div class="col s12 l8">
        <div class="card white z-depth-1">
          <div class="card-content">
            <span class="card-title" style="font-size:1.1rem; font-weight:700;">Últimas ventas</span>

            <div class="table-wrap">
              <table class="striped">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N°</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  {% if ultimas_ventas %}
                    {% for v in ultimas_ventas %}
                      <tr>
                        <td>{{ v.fecha }}</td>
                        <td>{{ v.nro }}</td>
                        <td>{{ v.cliente }}</td>
                        <td>$ {{ v.total }}</td>
                        <td>{{ v.estado }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="5" class="muted">Aún no hay ventas registradas hoy.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <div style="margin-top:12px;">
              <a class="btn-flat waves-effect" href="/ventas/">Ver todas</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col s12 l4">
        <div class="card white z-depth-1">
          <div class="card-content">
            <span class="card-title" style="font-size:1.1rem; font-weight:700;">Alertas</span>

            {% if alertas %}
              <ul class="collection" style="border-radius:12px; overflow:hidden;">
                {% for a in alertas %}
                  <li class="collection-item">{{ a.texto }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="card-panel" style="background:#efe8da; color:#5d4a3f;">
                Todo en orden. Sin alertas por ahora.
              </div>
            {% endif %}

            <div class="card-panel" style="background:#f4e7d7; color:#6d5548;">
              Pendientes sugeridos:
              <ul style="margin:8px 0 0 18px;">
                <li>Controlar stock mínimo</li>
                <li>Revisar precios sin definir</li>
                <li>Cierre de caja al final del día</li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.M && M.Dropdown) {
        M.Dropdown.init(document.querySelectorAll('.dropdown-trigger'), { coverTrigger:false, constrainWidth:false });
      }
    });
    (function () {
      const dateEl = document.getElementById('core_nav_date');
      const timeEl = document.getElementById('core_nav_time');
      function tick(){
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        if (dateEl) dateEl.innerHTML = '<i class="material-icons">calendar_today</i> ' + dd + '/' + mm + '/' + yyyy;
        if (timeEl) timeEl.innerHTML = '<i class="material-icons">schedule</i> ' + hh + ':' + mi;
      }
      tick();
      setInterval(tick, 10000);
    })();
  </script>
</body>
</html>
